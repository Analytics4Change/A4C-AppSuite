---
status: current
last_updated: 2025-12-30
---

<!-- TL;DR-START -->
## TL;DR

**Summary**: Shadow table for Supabase Auth users enabling RLS policies and multi-organization access tracking. User IDs must match `auth.users.id`. Tracks current organization context, accessible organizations array, and user metadata.

**When to read**:
- Understanding user-organization relationships
- Implementing multi-org access or context switching
- Working with user RLS policies (self-access, org-admin, super-admin)
- Syncing Supabase Auth users with application data

**Prerequisites**: [Supabase Auth Setup](../../guides/supabase/JWT-CLAIMS-SETUP.md)

**Key topics**: `users`, `supabase-auth`, `multi-org-access`, `rls-policies`, `gdpr-compliance`

**Estimated read time**: 25 minutes
<!-- TL;DR-END -->

# users

## Overview

The `users` table is a shadow table for Supabase Auth users, used for Row-Level Security (RLS) enforcement and application-level audit trails. This table mirrors core authentication data from Supabase's `auth.users` table but provides additional application-specific fields for organizational context, multi-tenant access, and user management.

**Key Purposes**:
- Enable RLS policies to reference user data without joining to `auth.users` schema
- Track user's current organizational context
- Manage multi-organization access for users
- Store application-specific metadata
- Audit user activity (last login, active status)

**Important**: User IDs in this table **must** match the UUIDs generated by Supabase Auth in `auth.users.id`. User creation is handled by Supabase Auth flows, with this table populated via database hooks or Edge Functions.

## Table Schema

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | uuid | NO | - | Primary key (matches auth.users.id from Supabase Auth) |
| email | text | NO | - | User email address (synced from auth.users) |
| name | text | YES | - | User full name or display name |
| current_organization_id | uuid | YES | - | Currently selected organization context |
| accessible_organizations | uuid[] | YES | - | Array of organization IDs user can access |
| metadata | jsonb | YES | '{}' | Additional custom user metadata |
| last_login | timestamptz | YES | - | Timestamp of most recent authentication |
| is_active | boolean | YES | true | User active status (can be disabled) |
| created_at | timestamptz | YES | NOW() | Record creation timestamp |
| updated_at | timestamptz | YES | NOW() | Record update timestamp |

### Column Details

#### id
- **Type**: `uuid`
- **Purpose**: Unique identifier matching Supabase Auth user ID
- **Source**: **MUST** match `auth.users.id` from Supabase Auth
- **Constraints**: PRIMARY KEY
- **Usage**: Referenced by all user-related foreign keys (user_roles, audit logs, etc.)
- **Important**: Do NOT generate this ID independently - use the ID from Supabase Auth signup

#### email
- **Type**: `text`
- **Purpose**: User email address for identification
- **Source**: Synced from `auth.users.email`
- **Constraints**: NOT NULL
- **Usage**: User lookup, display, communication
- **Note**: Email changes handled by Supabase Auth, must be synced to this table

#### current_organization_id
- **Type**: `uuid`
- **Purpose**: Track user's currently selected organizational context
- **Foreign Key**: References `organizations_projection(id)`
- **Nullable**: YES (NULL during initial setup or if no org assigned)
- **Usage**:
  - Multi-tenant context switching
  - JWT claims generation (org_id)
  - Default organization for operations
- **Validation**: Must be in user's `accessible_organizations` array

#### accessible_organizations
- **Type**: `uuid[]` (array of UUIDs)
- **Purpose**: List of all organizations user can access
- **Usage**:
  - Multi-tenant access control
  - Organization switching in UI
  - Cross-organizational workflows
- **Example**: `{uuid1, uuid2, uuid3}`
- **Validation**: All UUIDs must exist in `organizations_projection`
- **Note**: Empty array means user has no organizational access

#### metadata
- **Type**: `jsonb`
- **Purpose**: Store additional custom user metadata
- **Default**: `{}`
- **Usage**: Application-specific user preferences, settings, feature flags
- **Schema**: Flexible (application-defined)
- **Example**: See JSONB Columns section below

#### last_login
- **Type**: `timestamptz`
- **Purpose**: Track most recent user authentication
- **Updated**: On successful login via database hook or Edge Function
- **Usage**: Audit trails, inactive user detection, security monitoring

#### is_active
- **Type**: `boolean`
- **Purpose**: Enable/disable user account
- **Default**: `true`
- **Impact**:
  - Inactive users cannot authenticate
  - Inactive users excluded from queries
  - Can be used for soft deletion of users
- **Note**: Different from Supabase Auth's ban/delete (application-level control)

## Relationships

### Parent Relationships (Foreign Keys)

- **auth.users** (Supabase Auth schema) → `id`
  - Implicit relationship (not enforced by foreign key due to schema separation)
  - User ID must match Supabase Auth user
  - Managed by application logic and database hooks

- **organizations_projection** → `current_organization_id`
  - Foreign key (not explicitly defined in SQL, enforced by application)
  - User's currently active organization
  - Must be in `accessible_organizations` array

### Child Relationships (Referenced By)

- **user_roles_projection** ← `user_id`
  - One-to-many relationship
  - User can have multiple roles across different organizations
  - Cascade behavior: ON DELETE CASCADE

- **audit_log** ← `user_id`
  - One-to-many relationship
  - Audit trail of user actions
  - Cascade behavior: Typically RESTRICT (preserve audit trail)

- **api_audit_log** ← `user_id`
  - One-to-many relationship
  - API request audit logs
  - Cascade behavior: Typically RESTRICT (preserve audit trail)

- **invitations_projection** ← `invited_by_user_id`
  - One-to-many relationship
  - Track who invited new users
  - Cascade behavior: SET NULL (preserve invitation record)

## Indexes

### Primary Index
```sql
PRIMARY KEY (id)
```
- **Purpose**: Fast lookups by user ID
- **Performance**: O(log n) lookups
- **Usage**: All user-related queries, foreign key references

### Business Logic Indexes

#### idx_users_email
```sql
CREATE INDEX idx_users_email ON users(email);
```
- **Purpose**: Fast user lookup by email address
- **Usage**:
  - Login flows
  - User search by email
  - Email uniqueness validation
- **Performance**: Enables efficient email-based queries

#### idx_users_current_organization
```sql
CREATE INDEX idx_users_current_organization ON users(current_organization_id);
```
- **Purpose**: Filter users by their current organization
- **Usage**:
  - Organization user management
  - Context-specific user queries
  - Reporting and analytics
- **Performance**: Faster than scanning all users

#### idx_users_roles
```sql
CREATE INDEX idx_users_roles ON users USING GIN (accessible_organizations);
```
- **Purpose**: Enable efficient queries on accessible organizations array
- **Type**: GIN (Generalized Inverted Index) for array containment
- **Usage**:
  - Find all users with access to an organization: `WHERE '<org-uuid>' = ANY(accessible_organizations)`
  - Multi-tenant access queries
- **Performance**: Essential for array containment queries

#### idx_users_external_id
```sql
CREATE INDEX idx_users_external_id ON users((metadata->>'external_id'));
```
- **Purpose**: Index extracted external_id from JSONB metadata
- **Usage**: Lookup users by external system IDs (if used)
- **Performance**: Enables fast metadata field queries
- **Note**: Functional index on JSONB field extraction

## RLS Policies

### enable_rls
```sql
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
```

**Purpose**: Enforce multi-tenant data isolation and user privacy at database level

### SELECT Policy: users_super_admin_all

```sql
DROP POLICY IF EXISTS users_super_admin_all ON users;
CREATE POLICY users_super_admin_all
  ON users
  FOR ALL
  USING (is_super_admin(get_current_user_id()));
```

**Purpose**: Super administrators can view/manage all users across all organizations

**Logic**:
- Calls `is_super_admin(user_id)` function
- Checks if current user has `super_admin` role
- Bypasses all tenant isolation
- Allows SELECT, INSERT, UPDATE, DELETE

**Testing**:
```sql
-- Test as super admin (should see all users)
SET request.jwt.claim.user_id = '<super-admin-uuid>';
SELECT COUNT(*) FROM users;  -- All users across all orgs
```

### SELECT Policy: users_org_admin_select

```sql
DROP POLICY IF EXISTS users_org_admin_select ON users;
CREATE POLICY users_org_admin_select
  ON users
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1
      FROM user_roles_projection ur
      WHERE ur.user_id = users.id
        AND is_org_admin(get_current_user_id(), ur.org_id)
    )
  );
```

**Purpose**: Organization administrators can view users in their organization

**Logic**:
- Joins with `user_roles_projection` to find user's organizations
- Calls `is_org_admin(current_user_id, org_id)` for each user's org
- Returns users who have roles in current admin's organization
- Allows viewing users across all orgs the admin manages

**Testing**:
```sql
-- Test as org admin (should only see users in their org)
SET request.jwt.claim.user_id = '<org-admin-uuid>';
SET request.jwt.claim.org_id = '<organization-uuid>';
SELECT * FROM users;  -- Only users with roles in this org
```

### SELECT Policy: users_own_profile_select

```sql
DROP POLICY IF EXISTS users_own_profile_select ON users;
CREATE POLICY users_own_profile_select
  ON users
  FOR SELECT
  USING (id = get_current_user_id());
```

**Purpose**: Users can view their own profile

**Logic**:
- Simple equality check: `id = get_current_user_id()`
- Returns only the current user's own record
- Most restrictive policy (self-access only)

**Testing**:
```sql
-- Test as regular user (should only see own profile)
SET request.jwt.claim.user_id = '<user-uuid>';
SELECT * FROM users;  -- Only own user record
```

**Security Note**: Three-tier access model:
1. **Super admins**: See all users
2. **Org admins**: See users in their organizations
3. **Regular users**: See only their own profile

## Constraints

### Unique Constraints

**None explicitly defined** - Email uniqueness is enforced by Supabase Auth in `auth.users`, not in this shadow table.

**Important**: If email uniqueness is required at application level, consider adding:
```sql
CREATE UNIQUE INDEX idx_users_email_unique ON users(email);
```

### Check Constraints

**None explicitly defined** - Consider adding validation constraints:

**Suggested Constraint** - Validate current_organization is accessible:
```sql
-- NOT IMPLEMENTED YET - example of useful constraint
ALTER TABLE users
ADD CONSTRAINT check_current_org_accessible
CHECK (
  current_organization_id IS NULL
  OR current_organization_id = ANY(accessible_organizations)
);
```

## Triggers

### None Currently

**Rationale**: User management is handled by Supabase Auth hooks and Edge Functions, not database triggers.

**User Creation Flow**:
1. User signs up via Supabase Auth (creates `auth.users` record)
2. Database hook or Edge Function creates corresponding `users` record
3. User assigned to organization(s) via application logic

## Usage Examples

### Create a User (After Supabase Auth Signup)

```sql
-- IMPORTANT: ID must match auth.users.id from Supabase Auth
INSERT INTO users (
  id,  -- From Supabase Auth signup response
  email,
  name,
  current_organization_id,
  accessible_organizations,
  last_login,
  is_active,
  created_at
) VALUES (
  '<auth-user-uuid>',  -- From auth.users.id
  'user@example.com',
  'John Doe',
  '<organization-uuid>',
  ARRAY['<organization-uuid>']::uuid[],
  NOW(),
  true,
  NOW()
) RETURNING *;
```

**Important**: Never manually generate `id` - always use Supabase Auth's generated UUID

### Query User Profile

```sql
-- Get user profile with current organization details
SELECT
  u.id,
  u.email,
  u.name,
  u.current_organization_id,
  o.name AS current_org_name,
  u.accessible_organizations,
  u.is_active,
  u.last_login
FROM users u
LEFT JOIN organizations_projection o ON u.current_organization_id = o.id
WHERE u.id = '<user-uuid>';
```

### Switch User's Current Organization

```sql
-- Update user's current organizational context
UPDATE users
SET
  current_organization_id = '<new-organization-uuid>',
  updated_at = NOW()
WHERE id = '<user-uuid>'
  AND '<new-organization-uuid>' = ANY(accessible_organizations);  -- Validate access
```

**Validation**: Ensure new organization is in `accessible_organizations` array

### Grant User Access to Organization

```sql
-- Add organization to user's accessible list
UPDATE users
SET
  accessible_organizations = array_append(accessible_organizations, '<new-org-uuid>'),
  updated_at = NOW()
WHERE id = '<user-uuid>'
  AND NOT ('<new-org-uuid>' = ANY(accessible_organizations));  -- Prevent duplicates
```

### Revoke User Access to Organization

```sql
-- Remove organization from user's accessible list
UPDATE users
SET
  accessible_organizations = array_remove(accessible_organizations, '<org-to-remove-uuid>'),
  current_organization_id = CASE
    WHEN current_organization_id = '<org-to-remove-uuid>' THEN NULL
    ELSE current_organization_id
  END,
  updated_at = NOW()
WHERE id = '<user-uuid>';
```

**Important**: Clear `current_organization_id` if removing current org

### Update Last Login Timestamp

```sql
-- Track user authentication
UPDATE users
SET
  last_login = NOW(),
  updated_at = NOW()
WHERE id = '<user-uuid>';
```

### Deactivate User

```sql
-- Disable user account (soft delete)
UPDATE users
SET
  is_active = false,
  updated_at = NOW()
WHERE id = '<user-uuid>';
```

**Note**: Consider also disabling in Supabase Auth for complete account lockout

### Common Queries

#### Find Users by Organization

```sql
-- Get all users with access to an organization
SELECT
  u.id,
  u.email,
  u.name,
  u.current_organization_id,
  u.is_active,
  u.last_login
FROM users u
WHERE '<organization-uuid>' = ANY(u.accessible_organizations)
  AND u.is_active = true
ORDER BY u.name;
```

#### Find Users by Email (Case-Insensitive)

```sql
SELECT *
FROM users
WHERE LOWER(email) = LOWER('user@example.com');
```

#### Find Inactive Users

```sql
-- Users who haven't logged in for 90 days
SELECT
  id,
  email,
  name,
  last_login,
  current_organization_id
FROM users
WHERE last_login < NOW() - INTERVAL '90 days'
  AND is_active = true
ORDER BY last_login ASC;
```

#### Count Users by Organization

```sql
SELECT
  o.id AS organization_id,
  o.name AS organization_name,
  COUNT(DISTINCT u.id) AS user_count
FROM organizations_projection o
LEFT JOIN users u ON o.id = ANY(u.accessible_organizations)
WHERE o.deleted_at IS NULL
  AND o.is_active = true
GROUP BY o.id, o.name
ORDER BY user_count DESC;
```

## Audit Trail

### Event Emission

This table can participate in the CQRS event-driven architecture:

- **Events Potentially Emitted**:
  - `user.user_created` - When new user record created
  - `user.user_updated` - When user details modified
  - `user.organization_switched` - When current_organization_id changes
  - `user.access_granted` - When organization added to accessible_organizations
  - `user.access_revoked` - When organization removed from accessible_organizations
  - `user.user_deactivated` - When is_active set to false

- **Event Data**: See AsyncAPI schema (if defined) in `infrastructure/supabase/contracts/asyncapi/domains/user.yaml`

- **Current Implementation**: Events may be emitted by Edge Functions or Temporal workflows, not by database triggers

### Audit Log Integration

- User actions tracked in `audit_log` table (user_id foreign key)
- API requests logged in `api_audit_log` table
- Last login timestamp provides basic activity tracking
- For complete audit trail, query both audit tables filtering by `user_id`

## JSONB Columns

### metadata

**Purpose**: Store additional custom user metadata that doesn't warrant dedicated columns

**Schema**: Flexible - application-defined structure

**Example Value**:
```json
{
  "preferences": {
    "theme": "dark",
    "language": "en",
    "notifications_enabled": true,
    "timezone": "America/New_York"
  },
  "onboarding": {
    "completed": true,
    "completed_at": "2024-10-15T14:30:00Z",
    "steps_completed": ["profile", "org_setup", "invite_team"]
  },
  "external_id": "EXT-12345",  -- Indexed via idx_users_external_id
  "feature_flags": {
    "beta_features": true,
    "advanced_analytics": false
  }
}
```

**Validation**: Performed at application layer (Edge Functions, frontend)

**Indexing**: Functional index exists for `external_id`:
```sql
CREATE INDEX idx_users_external_id ON users((metadata->>'external_id'));
```

**Querying JSONB**:
```sql
-- Find users with specific metadata
SELECT * FROM users WHERE metadata->>'external_id' = 'EXT-12345';

-- Find users with dark theme preference
SELECT * FROM users WHERE metadata->'preferences'->>'theme' = 'dark';

-- Find users who completed onboarding
SELECT * FROM users WHERE (metadata->'onboarding'->>'completed')::boolean = true;
```

## Migration History

### Initial Creation
- **Date**: 2024-10-15 (estimated)
- **Migration**: `table.sql`
- **Purpose**: Shadow table for Supabase Auth users

### Schema Changes
_No documented schema changes yet_

## Performance Considerations

### Query Performance
- **Expected row count**: 100-10,000 users in typical deployment
- **Growth rate**: Moderate (new users weekly/monthly)
- **Hot paths**:
  - Lookup by ID (primary key) - extremely fast
  - Lookup by email (indexed) - fast
  - Filter by current_organization_id (indexed) - fast
  - Array containment on accessible_organizations (GIN indexed) - fast
- **Optimization strategies**:
  - Use GIN index for array queries
  - Avoid full table scans on large datasets
  - Index frequently queried metadata fields

### Index Strategy
- **Email index**: Essential for login flows
- **Organization indexes**: Enable efficient multi-tenant queries
- **GIN index on array**: Crucial for accessible_organizations queries
- **Trade-offs**:
  - Multiple indexes slow down writes slightly
  - Read performance significantly improved
- **Maintenance**: VACUUM regularly; REINDEX if performance degrades

## Security Considerations

### Data Sensitivity
- **Sensitivity Level**: CONFIDENTIAL
- **PII/PHI**: Contains user email, name (personally identifiable information)
- **Compliance**:
  - GDPR applies (user data must be deletable/exportable)
  - HIPAA may apply if health-related metadata stored
  - Right to be forgotten (GDPR Article 17)

### Access Control
- **RLS policies**: Three-tier access model (super admin > org admin > self)
- **Super admin bypass**: Platform administrators can view all users
- **Org admin access**: Organization administrators can view users in their orgs
- **Self-access**: Users can view their own profile

### Encryption
- **At-rest encryption**: Handled by PostgreSQL/Supabase (AES-256)
- **In-transit encryption**: TLS/SSL connections required
- **Column-level encryption**: Consider encrypting sensitive metadata fields if storing PHI

### GDPR Compliance

**Right to Access** (Article 15):
```sql
-- Export user data
SELECT * FROM users WHERE id = '<user-uuid>';
```

**Right to Erasure** (Article 17):
```sql
-- Delete user data (after deleting from Supabase Auth)
DELETE FROM users WHERE id = '<user-uuid>';
```

**Data Portability** (Article 20):
```sql
-- Export user data in JSON format
SELECT row_to_json(u.*) FROM users u WHERE id = '<user-uuid>';
```

## Troubleshooting

### Common Issues

#### RLS Policy Prevents User Viewing
**Symptom**: Query returns empty result set despite user existing

**Cause**: RLS policies blocking access (not super admin, org admin, or self)

**Solution**:
```sql
-- Verify current user context
SELECT get_current_user_id();

-- Check if user has necessary role
SELECT is_super_admin(get_current_user_id());
SELECT is_org_admin(get_current_user_id(), '<org-uuid>');
```

#### User ID Mismatch with Supabase Auth
**Symptom**: Authentication succeeds but user not found in database

**Cause**: User record not created in `users` table after Supabase Auth signup

**Solution**:
1. Check if user exists in Supabase Auth Dashboard
2. Verify database hook is registered and functioning
3. Manually create user record with matching ID from `auth.users`

#### Current Organization Not in Accessible Organizations
**Symptom**: `current_organization_id` set but not in `accessible_organizations` array

**Cause**: Data inconsistency (organization removed without clearing current_organization_id)

**Solution**:
```sql
-- Fix inconsistent data
UPDATE users
SET current_organization_id = NULL
WHERE current_organization_id IS NOT NULL
  AND NOT (current_organization_id = ANY(accessible_organizations));
```

#### Array Containment Query Slow
**Symptom**: Queries with `ANY(accessible_organizations)` taking > 100ms

**Diagnosis**:
```sql
EXPLAIN ANALYZE
SELECT * FROM users WHERE '<org-uuid>' = ANY(accessible_organizations);
```

**Expected Plan**: Should use `idx_users_roles` GIN index

**Solution**:
- Verify GIN index exists: `\d users`
- REINDEX if needed: `REINDEX INDEX idx_users_roles;`
- VACUUM table: `VACUUM ANALYZE users;`

### Performance Issues

#### Slow Email Lookups
**Symptom**: Email-based queries taking > 50ms

**Diagnosis**:
```sql
EXPLAIN ANALYZE
SELECT * FROM users WHERE email = 'user@example.com';
```

**Expected Plan**: Should use `idx_users_email` index

**Solution**:
- Verify email index exists
- Use exact match (avoid ILIKE if possible)
- Consider case-insensitive functional index if needed:
  ```sql
  CREATE INDEX idx_users_email_lower ON users(LOWER(email));
  ```

## Related Documentation

- [Schema Overview](../schema-overview.md) - Complete database schema and ER diagrams
- [RLS Policies](../rls-policies.md) - Comprehensive RLS policy reference
- [Migration Guide](../../../guides/database/migration-guide.md) - How to create migrations
- [Supabase Auth Setup](../../../guides/supabase/JWT-CLAIMS-SETUP.md) - JWT custom claims configuration

## See Also

- **Related Tables**:
  - [organizations_projection](organizations_projection.md) - User organizations
  - [user_roles_projection](user_roles_projection.md) - User role assignments
  - [audit_log](audit_log.md) - User action audit trail
- **Database Functions**:
  - [get_current_user_id()](../functions/authorization.md#get_current_user_id)
  - [is_super_admin()](../functions/authorization.md#is_super_admin)
  - [is_org_admin()](../functions/authorization.md#is_org_admin)
- **Supabase Auth**: [Supabase Auth Documentation](https://supabase.com/docs/guides/auth)

---

**Last Updated**: 2025-01-12
**Applies To**: Database schema v1.0.0
**Status**: current
