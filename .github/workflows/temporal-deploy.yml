name: Deploy Temporal Workers

# This workflow builds the Temporal worker Docker image and deploys it to the k3s cluster.
# Prerequisites:
#   - KUBECONFIG secret must point to https://k8s.firstovertheline.com (public endpoint)
#   - See infrastructure/KUBECONFIG_UPDATE_GUIDE.md for setup instructions

on:
  push:
    branches:
      - main
    paths:
      - 'workflows/**'
      - '.github/workflows/temporal-deploy.yml'
    tags:
      - 'v*'
  pull_request:
    paths:
      - 'workflows/**'
      - '.github/workflows/temporal-deploy.yml'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/a4c-workflows

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-tags: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # Tag with commit SHA
            type=sha,prefix=,format=short
            # Tag with 'latest' on main branch
            type=raw,value=latest,enable={{is_default_branch}}
            # Tag with version on git tags (e.g., v1.0.0)
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./workflows
          file: ./workflows/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Image digest
        run: echo ${{ steps.build.outputs.digest }}

  deploy:
    name: Deploy Workers to Kubernetes
    needs: build-and-push
    # Only deploy on push to main (not PRs or tags)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          echo "Checking KUBECONFIG secret..."
          if [ -z "${{ secrets.KUBECONFIG }}" ]; then
            echo "‚ùå KUBECONFIG secret is empty"
            exit 1
          fi
          echo "‚úì KUBECONFIG secret exists and is not empty"

          # Try to decode the secret
          if echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config 2>/dev/null; then
            echo "‚úì Successfully decoded KUBECONFIG secret"
          else
            echo "‚ùå Failed to decode KUBECONFIG secret as base64"
            echo "Trying to use secret as plain text kubeconfig..."
            echo "${{ secrets.KUBECONFIG }}" > ~/.kube/config
          fi

          chmod 600 ~/.kube/config

          # Test kubectl connectivity
          echo "Testing kubectl configuration..."
          if timeout 30 kubectl cluster-info 2>/dev/null; then
            echo "‚úì kubectl configuration is valid and cluster is reachable"
          else
            echo "‚ùå kubectl cluster connection failed"
            echo ""
            echo "üåê NETWORK CONNECTIVITY ISSUE"
            echo "The kubeconfig format is valid, but the cluster is not reachable from GitHub Actions."
            echo ""
            echo "üìñ See infrastructure/KUBECONFIG_UPDATE_GUIDE.md for detailed setup instructions"
            echo ""
            echo "Possible solutions:"
            echo "1. Update KUBECONFIG to use https://k8s.firstovertheline.com (Cloudflare Tunnel)"
            echo "2. Ensure Cloudflare Tunnel is running on k3s host"
            echo "3. Verify DNS resolution: nslookup k8s.firstovertheline.com"
            echo "4. Test connectivity: curl -k https://k8s.firstovertheline.com/version"
            echo ""
            echo "Current cluster endpoint: $(grep 'server:' ~/.kube/config | head -1)"
            echo "Expected endpoint: https://k8s.firstovertheline.com"
            exit 1
          fi

          echo "‚úì kubectl configuration complete"

      - name: Deploy to k3s default namespace
        run: |
          # Get the first image tag from the multi-line output
          IMAGE_TAG=$(echo "${{ needs.build-and-push.outputs.image-tags }}" | head -n1)
          echo "Using image tag: $IMAGE_TAG"

          # Update the worker image
          kubectl set image deployment/workflow-worker \
            worker=$IMAGE_TAG \
            -n default

          echo "‚úÖ Image updated in deployment"

      - name: Wait for rollout
        run: |
          # Wait for rollout to complete
          if kubectl rollout status deployment/workflow-worker -n default --timeout=300s; then
            echo "‚úÖ Rollout completed successfully"
          else
            echo "‚ö†Ô∏è First rollout attempt timed out, checking actual deployment status..."

            # Check if deployment actually succeeded despite timeout
            READY_REPLICAS=$(kubectl get deployment workflow-worker -n default -o jsonpath='{.status.readyReplicas}')
            DESIRED_REPLICAS=$(kubectl get deployment workflow-worker -n default -o jsonpath='{.spec.replicas}')

            if [ "$READY_REPLICAS" = "$DESIRED_REPLICAS" ] && [ "$READY_REPLICAS" != "" ]; then
              echo "‚úÖ Deployment actually completed successfully ($READY_REPLICAS/$DESIRED_REPLICAS ready)"
            else
              echo "‚ùå Deployment failed - only $READY_REPLICAS/$DESIRED_REPLICAS replicas ready"
              kubectl get pods -l app=workflow-worker -n default
              kubectl describe deployment workflow-worker -n default
              exit 1
            fi
          fi

      - name: Verify deployment
        run: |
          echo "üìä Deployment Status:"
          kubectl get deployment workflow-worker -n default
          echo ""
          echo "üì¶ Pod Status:"
          kubectl get pods -l app=workflow-worker -n default
          echo ""
          echo "üîç Recent Events:"
          kubectl get events -n default --sort-by='.lastTimestamp' | tail -10

      - name: Report deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "üéâ Temporal worker deployment completed successfully!"
            echo "‚úÖ Workers are now running the latest code"
          else
            echo "‚ùå Deployment failed. Check the logs above for details."
          fi
