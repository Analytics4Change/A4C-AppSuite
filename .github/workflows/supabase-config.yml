name: Configure Supabase

# This workflow configures Supabase authentication and deploys Edge Functions.
# Prerequisites:
#   - SUPABASE_ACCESS_TOKEN secret (Management API token)
#   - GOOGLE_OAUTH_CLIENT_ID secret
#   - GOOGLE_OAUTH_CLIENT_SECRET secret
#   - TEST_USER_PASSWORD secret
#   - SUPABASE_URL secret (already configured)
#   - SUPABASE_SERVICE_ROLE_KEY secret (already configured)

on:
  push:
    branches:
      - main
    paths:
      - 'infrastructure/supabase/config/**'
      - 'infrastructure/supabase/functions/**'
      - 'infrastructure/supabase/scripts/**'
      - '.github/workflows/supabase-config.yml'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  configure-google-oauth:
    name: Configure Google OAuth Provider
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract project reference
        run: |
          PROJECT_REF=$(echo "${{ secrets.SUPABASE_URL }}" | sed 's|https://\([^.]*\).*|\1|')
          echo "PROJECT_REF=$PROJECT_REF" >> $GITHUB_ENV
          echo "‚úì Project ref: $PROJECT_REF"

      - name: Configure Google OAuth
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ env.PROJECT_REF }}
          GOOGLE_OAUTH_CLIENT_ID: ${{ secrets.GOOGLE_OAUTH_CLIENT_ID }}
          GOOGLE_OAUTH_CLIENT_SECRET: ${{ secrets.GOOGLE_OAUTH_CLIENT_SECRET }}
        run: |
          bash infrastructure/supabase/scripts/configure-google-oauth.sh

      - name: Report OAuth configuration status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "üéâ Google OAuth configured successfully!"
            echo "‚úÖ Users can now sign in with Google"
          else
            echo "‚ùå OAuth configuration failed. Check logs above for details."
          fi

  deploy-edge-functions:
    name: Deploy Edge Functions
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Extract project reference
        run: |
          PROJECT_REF=$(echo "${{ secrets.SUPABASE_URL }}" | sed 's|https://\([^.]*\).*|\1|')
          echo "PROJECT_REF=$PROJECT_REF" >> $GITHUB_ENV
          echo "‚úì Project ref: $PROJECT_REF"

      - name: Deploy Edge Functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          echo "üì¶ Deploying Edge Functions..."
          cd infrastructure/supabase

          # Deploy all functions
          supabase functions deploy --project-ref $PROJECT_REF

          echo "‚úÖ Edge Functions deployed successfully!"

      - name: List deployed functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          echo "üìã Deployed Edge Functions:"
          cd infrastructure/supabase
          supabase functions list --project-ref $PROJECT_REF

      - name: Report deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "üéâ Edge Functions deployed successfully!"
          else
            echo "‚ùå Edge Function deployment failed. Check logs above for details."
          fi

  create-test-users:
    name: Create Test Users
    needs: configure-google-oauth
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Supabase JS SDK
        run: |
          cd infrastructure/supabase/scripts
          npm init -y > /dev/null 2>&1
          npm install @supabase/supabase-js

      - name: Create test users
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
        run: |
          cd infrastructure/supabase/scripts
          node create-test-users.mjs

      - name: Report user creation status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "üéâ Test users created successfully!"
            echo "‚úÖ Users can login with email/password for testing"
          else
            echo "‚ùå Test user creation failed. Check logs above for details."
          fi
