name: Deploy Database Schema

# This workflow deploys the consolidated database schema to Supabase.
# All SQL is idempotent - safe to run multiple times.
#
# Prerequisites:
#   - SUPABASE_URL secret (e.g., https://your-project.supabase.co)
#   - SUPABASE_DB_PASSWORD secret
#
# Architecture:
#   - Source files: infrastructure/supabase/sql/** (granular, for development)
#   - Deployment: infrastructure/supabase/CONSOLIDATED_SCHEMA.sql (single file)

on:
  push:
    branches:
      - main
    paths:
      - 'infrastructure/supabase/CONSOLIDATED_SCHEMA.sql'
      - 'infrastructure/supabase/sql/**'
      - '.github/workflows/supabase-deploy.yml'
  workflow_dispatch:
    inputs:
      target_environment:
        description: 'Target environment'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production

jobs:
  validate-schema:
    name: Validate SQL Schema
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check consolidated schema exists
        run: |
          if [ ! -f "infrastructure/supabase/CONSOLIDATED_SCHEMA.sql" ]; then
            echo "âŒ CONSOLIDATED_SCHEMA.sql not found"
            echo "Run: cd infrastructure/supabase && ./scripts/consolidate-sql.sh"
            exit 1
          fi
          echo "âœ… Consolidated schema found"
          wc -l infrastructure/supabase/CONSOLIDATED_SCHEMA.sql

      - name: Check for idempotency patterns
        run: |
          echo "Checking for idempotency patterns in consolidated schema..."
          FILE="infrastructure/supabase/CONSOLIDATED_SCHEMA.sql"
          ISSUES=0

          # Check for CREATE TABLE without IF NOT EXISTS (excluding comments)
          if grep -E "^CREATE TABLE [^I]" "$FILE" | grep -v "IF NOT EXISTS"; then
            echo "âš ï¸  Found CREATE TABLE without IF NOT EXISTS"
            ISSUES=$((ISSUES+1))
          fi

          # Check for DROP TABLE (we should never drop tables)
          if grep -E "^DROP TABLE(?! IF EXISTS)" "$FILE"; then
            echo "âš ï¸  Found unsafe DROP TABLE statement"
            ISSUES=$((ISSUES+1))
          fi

          if [ $ISSUES -eq 0 ]; then
            echo "âœ… Idempotency checks passed"
          else
            echo "âš ï¸  $ISSUES potential issues found (may be false positives)"
          fi

  deploy-schema:
    name: Deploy Schema to Supabase
    needs: validate-schema
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.target_environment || 'development' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Configure database connection
        run: |
          # Extract project ref from Supabase URL
          PROJECT_REF=$(echo "${{ secrets.SUPABASE_URL }}" | sed 's|https://\([^.]*\).*|\1|')
          echo "PROJECT_REF=$PROJECT_REF" >> $GITHUB_ENV

          # Use Transaction Mode Pooler for GitHub Actions (IPv4 compatible, port 6543)
          DB_USER="postgres.${PROJECT_REF}"
          DB_HOST="aws-1-us-west-1.pooler.supabase.com"
          DB_PORT="6543"

          echo "DB_USER=$DB_USER" >> $GITHUB_ENV
          echo "DB_HOST=$DB_HOST" >> $GITHUB_ENV
          echo "DB_PORT=$DB_PORT" >> $GITHUB_ENV

      - name: Test database connection
        env:
          PGPASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          echo "Testing connection to Supabase database..."
          if psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d postgres -c "SELECT version();" 2>&1; then
            echo "âœ… Database connection successful"
          else
            echo "âŒ Database connection failed"
            exit 1
          fi

      - name: Deploy consolidated schema
        env:
          PGPASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          echo "Deploying consolidated schema..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          SCHEMA_FILE="infrastructure/supabase/CONSOLIDATED_SCHEMA.sql"
          START_TIME=$(date +%s)

          # Deploy schema (all statements are idempotent)
          if psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d postgres \
            -v ON_ERROR_STOP=1 \
            -f "$SCHEMA_FILE" > /tmp/deploy-output.log 2>&1; then

            END_TIME=$(date +%s)
            DURATION=$((END_TIME - START_TIME))

            echo "âœ… Schema deployed successfully in ${DURATION}s"
            echo ""
            echo "Deployment output (last 50 lines):"
            tail -50 /tmp/deploy-output.log
          else
            echo "âŒ Schema deployment FAILED"
            echo ""
            echo "Error output:"
            cat /tmp/deploy-output.log
            exit 1
          fi

      - name: Verify database state
        env:
          PGPASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          echo "Verifying database state..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Check table count
          TABLE_COUNT=$(psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d postgres -tAc \
            "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';")
          echo "ğŸ“‹ Total tables in public schema: $TABLE_COUNT"

          # Check function count
          FUNCTION_COUNT=$(psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d postgres -tAc \
            "SELECT COUNT(*) FROM pg_proc WHERE pronamespace = (SELECT oid FROM pg_namespace WHERE nspname = 'public');")
          echo "âš™ï¸  Total functions in public schema: $FUNCTION_COUNT"

          # Check RLS enabled
          RLS_COUNT=$(psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d postgres -tAc \
            "SELECT COUNT(*) FROM pg_tables WHERE schemaname = 'public' AND rowsecurity = true;")
          echo "ğŸ”’ Tables with RLS enabled: $RLS_COUNT"

          # Check domain_events (should have data)
          EVENT_COUNT=$(psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d postgres -tAc \
            "SELECT COUNT(*) FROM domain_events;")
          echo "ğŸ“Š Domain events: $EVENT_COUNT"

          echo ""
          echo "âœ… Database verification complete"

      - name: Report deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "ğŸ‰ Database schema deployed successfully!"
            echo "ğŸ”— Supabase Project: ${{ secrets.SUPABASE_URL }}"
          else
            echo "âŒ Schema deployment failed."
            echo "Check the logs above for details."
          fi
