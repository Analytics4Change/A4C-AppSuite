name: Deploy Frontend

# This workflow deploys the frontend React application to the k3s cluster via Cloudflare Tunnel.
# Prerequisites:
#   - KUBECONFIG secret must point to https://k8s.firstovertheline.com (public endpoint)
#   - See infrastructure/KUBECONFIG_UPDATE_GUIDE.md for setup instructions

on:
  push:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-deploy.yml'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: analytics4change/a4c-appsuite-frontend

jobs:
  build:
    name: Build and Push Frontend Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-tag: ${{ steps.meta.outputs.tags }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      working-directory: ./frontend
      run: npm ci

    - name: Run tests
      working-directory: ./frontend
      run: echo "Skipping tests - no unit tests configured"

    - name: Create production environment file
      working-directory: ./frontend
      run: |
        echo "Creating .env.production with Supabase credentials..."
        cat > .env.production << EOF
        # Deployment mode (production = real Supabase)
        VITE_APP_MODE=production

        # Supabase credentials (from GitHub Secrets)
        VITE_SUPABASE_URL=${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY=${{ secrets.VITE_SUPABASE_ANON_KEY }}

        # Medication search (using real RxNorm API)
        VITE_USE_RXNORM_API=true

        # Debug flags (enabled for development-like deployment)
        VITE_DEBUG_LOGS=true
        VITE_DEBUG_MOBX=false
        VITE_DEBUG_PERFORMANCE=false
        EOF
        echo "‚úì Environment file created with debug logging enabled"
        echo "Verifying environment variables are set..."
        if [ -z "${{ secrets.SUPABASE_URL }}" ]; then
          echo "‚ùå SUPABASE_URL secret is not set"
          exit 1
        fi
        if [ -z "${{ secrets.VITE_SUPABASE_ANON_KEY }}" ]; then
          echo "‚ùå VITE_SUPABASE_ANON_KEY secret is not set"
          exit 1
        fi
        echo "‚úì All required secrets are present"

    - name: Build React application
      working-directory: ./frontend
      run: npm run build

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          # Tag with commit SHA
          type=sha,prefix=,format=short
          # Tag with 'latest' on main branch
          type=raw,value=latest,enable={{is_default_branch}}
          # Tag with version on git tags (e.g., v1.0.0)
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}

    - name: Build and push Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        platforms: linux/amd64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha,scope=${{ github.ref_name }}
        cache-to: type=gha,mode=max,scope=${{ github.ref_name }}-${{ github.sha }}

  deploy:
    name: Deploy Frontend to Kubernetes
    needs: build
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      packages: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'

    - name: Configure kubectl
      run: |
        mkdir -p ~/.kube
        echo "Checking KUBECONFIG secret..."
        if [ -z "${{ secrets.KUBECONFIG }}" ]; then
          echo "‚ùå KUBECONFIG secret is empty"
          exit 1
        fi
        echo "‚úì KUBECONFIG secret exists and is not empty"
        echo "Secret length: $(echo '${{ secrets.KUBECONFIG }}' | wc -c) characters"

        # Try to decode the secret
        if echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config 2>/dev/null; then
          echo "‚úì Successfully decoded KUBECONFIG secret"
        else
          echo "‚ùå Failed to decode KUBECONFIG secret as base64"
          echo "Trying to use secret as plain text kubeconfig..."
          echo "${{ secrets.KUBECONFIG }}" > ~/.kube/config
        fi

        chmod 600 ~/.kube/config

        # Debug the config file format
        echo "--- Config file debug info ---"
        echo "First few lines of config:"
        head -5 ~/.kube/config || true
        echo "--- End debug info ---"

        # Test kubectl connectivity
        echo "Testing kubectl configuration..."
        if timeout 30 kubectl cluster-info 2>/dev/null; then
          echo "‚úì kubectl configuration is valid and cluster is reachable"
        else
          echo "‚ùå kubectl cluster connection failed"
          echo ""
          echo "üåê NETWORK CONNECTIVITY ISSUE"
          echo "The kubeconfig format is valid, but the cluster is not reachable from GitHub Actions."
          echo ""
          echo "üìñ See infrastructure/KUBECONFIG_UPDATE_GUIDE.md for detailed setup instructions"
          echo ""
          echo "Possible solutions:"
          echo "1. Update KUBECONFIG to use https://k8s.firstovertheline.com (Cloudflare Tunnel)"
          echo "2. Ensure Cloudflare Tunnel is running on k3s host"
          echo "3. Verify DNS resolution: nslookup k8s.firstovertheline.com"
          echo "4. Test connectivity: curl -k https://k8s.firstovertheline.com/version"
          echo ""
          echo "Current cluster endpoint: $(grep 'server:' ~/.kube/config | head -1)"
          echo "Expected endpoint: https://k8s.firstovertheline.com"
          exit 1
        fi

        echo "‚úì kubectl configuration complete"

    - name: Create image pull secret
      run: |
        kubectl create secret docker-registry ghcr-secret \
          --docker-server=ghcr.io \
          --docker-username=${{ github.actor }} \
          --docker-password=${{ secrets.K8S_IMAGE_PULL_TOKEN }} \
          --dry-run=client -o yaml | kubectl apply -f -

    - name: Deploy to k3s
      run: |
        # Get the commit SHA tag (not :latest) to force pod restart
        IMAGE_TAG=$(echo "${{ needs.build.outputs.image-tag }}" | grep -v latest | head -n1)
        echo "Using image tag: $IMAGE_TAG"

        # Update the frontend image using kubectl set image
        kubectl set image deployment/a4c-frontend \
          nginx=$IMAGE_TAG

        echo "‚úÖ Image updated in deployment"

    - name: Wait for rollout
      run: |
        # First attempt with standard timeout
        if kubectl rollout status deployment/a4c-frontend --timeout=300s; then
          echo "‚úÖ Rollout completed successfully"
        else
          echo "‚ö†Ô∏è First rollout attempt timed out, checking actual deployment status..."

          # Check if deployment actually succeeded despite timeout
          READY_REPLICAS=$(kubectl get deployment a4c-frontend -o jsonpath='{.status.readyReplicas}')
          DESIRED_REPLICAS=$(kubectl get deployment a4c-frontend -o jsonpath='{.spec.replicas}')

          if [ "$READY_REPLICAS" = "$DESIRED_REPLICAS" ] && [ "$READY_REPLICAS" != "" ]; then
            echo "‚úÖ Deployment actually completed successfully ($READY_REPLICAS/$DESIRED_REPLICAS ready)"
          else
            echo "‚ùå Deployment failed - only $READY_REPLICAS/$DESIRED_REPLICAS replicas ready"
            kubectl get pods -l app=a4c-frontend
            kubectl describe deployment a4c-frontend
            exit 1
          fi
        fi

    - name: Verify deployment
      run: |
        kubectl get pods -l app=a4c-frontend
        kubectl get service a4c-frontend-service
        kubectl get ingress a4c-frontend-ingress

    - name: Health check
      run: |
        # Wait a bit for the service to be ready
        sleep 30

        # Test the application
        if curl -f --retry 5 --retry-delay 10 https://a4c.firstovertheline.com/; then
          echo "‚úÖ Deployment successful - application is responding"
        else
          echo "‚ùå Deployment failed - application not responding"
          exit 1
        fi

    - name: Report deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "üéâ Deployment completed successfully!"
          echo "üåê Application URL: https://a4c.firstovertheline.com"
        else
          echo "‚ùå Deployment failed. Check the logs above for details."
        fi
