components:
  messages:
    OrganizationCreated:
      name: organization.created
      title: Organization Created
      summary: A new organization has been created in the hierarchy
      contentType: application/json
      payload:
        $ref: '#/components/schemas/OrganizationCreatedEvent'

    OrganizationUpdated:
      name: organization.updated
      title: Organization Updated
      summary: Organization information has been updated
      contentType: application/json
      payload:
        $ref: '#/components/schemas/OrganizationUpdatedEvent'

    OrganizationBusinessProfileCreated:
      name: organization.business_profile.created
      title: Organization Business Profile Created
      summary: Business profile created for top-level organization during onboarding
      contentType: application/json
      payload:
        $ref: '#/components/schemas/OrganizationBusinessProfileCreatedEvent'

    OrganizationBusinessProfileUpdated:
      name: organization.business_profile.updated
      title: Organization Business Profile Updated
      summary: Business profile information has been updated
      contentType: application/json
      payload:
        $ref: '#/components/schemas/OrganizationBusinessProfileUpdatedEvent'

    OrganizationDeactivated:
      name: organization.deactivated
      title: Organization Deactivated
      summary: Organization has been deactivated (billing, compliance, operational)
      contentType: application/json
      payload:
        $ref: '#/components/schemas/OrganizationDeactivatedEvent'

    OrganizationReactivated:
      name: organization.reactivated
      title: Organization Reactivated
      summary: Organization has been restored to active status
      contentType: application/json
      payload:
        $ref: '#/components/schemas/OrganizationReactivatedEvent'

    OrganizationDeleted:
      name: organization.deleted
      title: Organization Deleted
      summary: Organization has been logically deleted with cascade handling
      contentType: application/json
      payload:
        $ref: '#/components/schemas/OrganizationDeletedEvent'

    # Bootstrap Events - Organization creation via platform management
    OrganizationBootstrapInitiated:
      name: organization.bootstrap.initiated
      title: Organization Bootstrap Initiated
      summary: Bootstrap process started for new provider or provider_partner organization
      contentType: application/json
      payload:
        $ref: '#/components/schemas/OrganizationBootstrapInitiatedEvent'

    OrganizationBootstrapCompleted:
      name: organization.bootstrap.completed
      title: Organization Bootstrap Completed
      summary: Organization bootstrap process successfully completed
      contentType: application/json
      payload:
        $ref: '#/components/schemas/OrganizationBootstrapCompletedEvent'

    OrganizationBootstrapFailed:
      name: organization.bootstrap.failed
      title: Organization Bootstrap Failed
      summary: Organization bootstrap process failed, triggering compensation
      contentType: application/json
      payload:
        $ref: '#/components/schemas/OrganizationBootstrapFailedEvent'

    OrganizationBootstrapCancelled:
      name: organization.bootstrap.cancelled
      title: Organization Bootstrap Cancelled
      summary: Organization bootstrap process cancelled and cleanup completed
      contentType: application/json
      payload:
        $ref: '#/components/schemas/OrganizationBootstrapCancelledEvent'

    # Subdomain Provisioning Events
    OrganizationSubdomainDnsCreated:
      name: organization.subdomain.dns_created
      title: Organization Subdomain DNS Created
      summary: DNS CNAME record created in Cloudflare for organization subdomain
      contentType: application/json
      payload:
        $ref: '#/components/schemas/OrganizationSubdomainDnsCreatedEvent'

    OrganizationSubdomainVerified:
      name: organization.subdomain.verified
      title: Organization Subdomain Verified
      summary: DNS resolution verified for organization subdomain
      contentType: application/json
      payload:
        $ref: '#/components/schemas/OrganizationSubdomainVerifiedEvent'

    OrganizationSubdomainVerificationFailed:
      name: organization.subdomain.verification_failed
      title: Organization Subdomain Verification Failed
      summary: DNS verification failed for organization subdomain
      contentType: application/json
      payload:
        $ref: '#/components/schemas/OrganizationSubdomainVerificationFailedEvent'

  schemas:
    OrganizationCreatedEvent:
      type: object
      required:
        - stream_id
        - stream_type
        - event_type
        - event_data
        - event_metadata
      properties:
        stream_id:
          type: string
          format: uuid
          description: Organization UUID
        stream_type:
          type: string
          enum: [organization]
        event_type:
          type: string
          enum: [organization.created]
        event_data:
          $ref: '#/components/schemas/OrganizationCreationData'
        event_metadata:
          $ref: '../components/schemas.yaml#/components/schemas/EventMetadata'

    OrganizationCreationData:
      type: object
      required:
        - name
        - slug
        - type
        - path
      properties:
        name:
          type: string
          maxLength: 200
          description: Human-readable organization name
          examples:
            - "ACME Healthcare Services"
            - "North Campus"
        display_name:
          type: string
          maxLength: 200
          description: Display name for UI (may differ from name)
        slug:
          type: string
          maxLength: 100
          pattern: '^[a-z0-9-]+$'
          description: URL-friendly identifier
          examples:
            - "acme-healthcare"
            - "north-campus"
        type:
          type: string
          enum: [platform_owner, provider, provider_partner]
          description: |
            Organization type determining access patterns and capabilities:
            - platform_owner: A4C internal organization (impersonation capability)
            - provider: Healthcare organizations serving clients (data owners)
            - provider_partner: External stakeholders (VARs, families, courts - access via grants)
        partner_type:
          type: string
          enum: [var, family, court, other]
          description: |
            Partner organization subtype (required when type=provider_partner):
            - var: Value-Added Reseller (requires subdomain, gets portal access)
            - family: Family access partner (no subdomain, limited dashboard views)
            - court: Court system partner (no subdomain, limited dashboard views)
            - other: Other stakeholder partner (no subdomain, limited dashboard views)
        referring_partner_id:
          type: string
          format: uuid
          description: UUID of the partner organization that referred this provider (NULL if not referred)
        path:
          type: string
          description: ltree hierarchical path
          examples:
            - "root.org_acme_healthcare"
            - "root.org_acme_healthcare.north_campus"
        parent_path:
          type: string
          description: Parent organization ltree path (NULL for root organizations)
        tax_number:
          type: string
          maxLength: 50
          description: Tax identification number
        phone_number:
          type: string
          maxLength: 20
          description: Primary phone number
        timezone:
          type: string
          default: "America/New_York"
          description: Organization timezone
        metadata:
          type: object
          description: Additional flexible data storage

    OrganizationBusinessProfileCreatedEvent:
      type: object
      required:
        - stream_id
        - stream_type
        - event_type
        - event_data
        - event_metadata
      properties:
        stream_id:
          type: string
          format: uuid
          description: Organization UUID
        stream_type:
          type: string
          enum: [organization]
        event_type:
          type: string
          enum: [organization.business_profile.created]
        event_data:
          $ref: '#/components/schemas/OrganizationBusinessProfileData'
        event_metadata:
          $ref: '../components/schemas.yaml#/components/schemas/EventMetadata'

    OrganizationBusinessProfileData:
      type: object
      required:
        - organization_type
      properties:
        organization_type:
          type: string
          enum: [provider, provider_partner]
          description: Type of business profile (platform_owner organizations don't have business profiles)
        mailing_address:
          $ref: '../components/schemas.yaml#/components/schemas/Address'
        physical_address:
          $ref: '../components/schemas.yaml#/components/schemas/Address'
        provider_profile:
          $ref: '#/components/schemas/ProviderBusinessProfile'
        partner_profile:
          $ref: '#/components/schemas/ProviderPartnerBusinessProfile'

    ProviderBusinessProfile:
      type: object
      description: Business profile for Provider organizations (from Tenant-Management.png)
      required:
        - administrator_name
        - administrator_email
        - main_phone_number
        - email
        - program_name
      properties:
        # Billing Information (Provider-specific)
        billing_name:
          type: string
          maxLength: 200
        billing_tax:
          type: string
          maxLength: 50
        billing_address:
          $ref: '../components/schemas.yaml#/components/schemas/Address'
        
        # Provider Admin
        administrator_name:
          type: string
          maxLength: 200
        administrator_email:
          type: string
          format: email
        email_provider:
          type: string
          maxLength: 100
        
        # Contact Information
        main_phone_number:
          type: string
          maxLength: 20
        additional_phone_number:
          type: string
          maxLength: 20
        fax_number:
          type: string
          maxLength: 20
        email:
          type: string
          format: email

        # Service Information (Provider-specific)
        service_types:
          type: array
          items:
            type: string
          description: Services offered by this provider

    ProviderPartnerBusinessProfile:
      type: object
      description: Business profile for Provider Partner organizations (from Tenant-Management-Provider-Partner.png)
      required:
        - contact_name
        - contact_email
        - contact_phone
        - administrator_name
        - administrator_email
      properties:
        # Contact Information
        contact_name:
          type: string
          maxLength: 200
        contact_address:
          $ref: '../components/schemas.yaml#/components/schemas/Address'
        contact_email:
          type: string
          format: email
        contact_phone:
          type: string
          maxLength: 20
        
        # Provider Partner Admin
        administrator_name:
          type: string
          maxLength: 200
        administrator_email:
          type: string
          format: email
        email_provider:
          type: string
          maxLength: 100
        
        # Partner-specific metadata
        partner_type:
          type: string
          enum: [var, family, court, other]
          description: |
            Type of provider partner relationship:
            - var: Value-Added Reseller (gets portal access)
            - family: Family access partner (limited dashboard views)
            - court: Court system partner (limited dashboard views)
            - other: Other stakeholder partner (limited dashboard views)

    OrganizationDeactivatedEvent:
      type: object
      required:
        - stream_id
        - stream_type
        - event_type
        - event_data
        - event_metadata
      properties:
        stream_id:
          type: string
          format: uuid
        stream_type:
          type: string
          enum: [organization]
        event_type:
          type: string
          enum: [organization.deactivated]
        event_data:
          $ref: '#/components/schemas/OrganizationDeactivationData'
        event_metadata:
          $ref: '../components/schemas.yaml#/components/schemas/EventMetadata'

    OrganizationDeactivationData:
      type: object
      required:
        - organization_id
        - deactivation_type
        - effective_date
        - cascade_to_children
        - login_blocked
        - role_assignment_blocked
        - existing_users_affected
      properties:
        organization_id:
          type: string
          format: uuid
        deactivation_type:
          type: string
          enum: [billing_suspension, compliance_violation, voluntary_suspension, maintenance]
        effective_date:
          type: string
          format: date-time
        cascade_to_children:
          type: boolean
          description: Whether deactivation affects child organizations
        login_blocked:
          type: boolean
          description: Whether authentication is blocked (Platform Owner use case)
        role_assignment_blocked:
          type: boolean
          description: Whether new role assignments are blocked (Descendant OU use case)
        existing_users_affected:
          type: boolean
          description: Whether current user sessions are terminated
        reactivation_conditions:
          type: array
          items:
            type: string
          description: Conditions that must be met for reactivation

    OrganizationDeletedEvent:
      type: object
      required:
        - stream_id
        - stream_type
        - event_type
        - event_data
        - event_metadata
      properties:
        stream_id:
          type: string
          format: uuid
        stream_type:
          type: string
          enum: [organization]
        event_type:
          type: string
          enum: [organization.deleted]
        event_data:
          $ref: '#/components/schemas/OrganizationDeletionData'
        event_metadata:
          $ref: '../components/schemas.yaml#/components/schemas/EventMetadata'

    OrganizationDeletionData:
      type: object
      required:
        - organization_id
        - deleted_path
        - deletion_strategy
        - cascade_confirmed
      properties:
        organization_id:
          type: string
          format: uuid
        deleted_path:
          type: string
          description: ltree path being deleted
          examples:
            - "root.org_acme_healthcare.north_campus"
        deletion_strategy:
          type: string
          enum: [cascade_delete, block_if_children]
          description: How to handle child organizations
        cascade_confirmed:
          type: boolean
          description: User explicitly confirmed cascade deletion of children

    # Organization Update Event - emitted when organization properties change
    OrganizationUpdatedEvent:
      type: object
      required:
        - stream_id
        - stream_type
        - event_type
        - event_data
        - event_metadata
      properties:
        stream_id:
          type: string
          format: uuid
          description: Organization UUID
        stream_type:
          type: string
          enum: [organization]
        event_type:
          type: string
          enum: [organization.updated]
        event_data:
          $ref: '#/components/schemas/OrganizationUpdateData'
        event_metadata:
          $ref: '../components/schemas.yaml#/components/schemas/EventMetadata'

    OrganizationUpdateData:
      type: object
      required:
        - organization_id
        - updated_fields
      properties:
        organization_id:
          type: string
          format: uuid
          description: UUID of the organization being updated
        name:
          type: string
          maxLength: 200
          description: Updated organization name (only present if changed)
        display_name:
          type: string
          maxLength: 200
          description: Updated display name (only present if changed)
        timezone:
          type: string
          description: Updated timezone (only present if changed)
          examples:
            - "America/New_York"
            - "America/Chicago"
            - "America/Los_Angeles"
        is_active:
          type: boolean
          description: Updated active status (only present if changed)
        updated_fields:
          type: array
          items:
            type: string
            enum: [name, display_name, timezone, is_active]
          description: List of fields that were updated in this event
          examples:
            - ["name", "display_name"]
            - ["timezone"]
            - ["is_active"]
        previous_values:
          type: object
          description: Previous values of updated fields (for audit trail)
          additionalProperties: true

    OrganizationBusinessProfileUpdatedEvent:
      type: object
      properties:
        stream_id:
          type: string
          format: uuid
        stream_type:
          type: string
          enum: [organization]
        event_type:
          type: string
          enum: [organization.business_profile.updated]

    OrganizationReactivatedEvent:
      type: object
      properties:
        stream_id:
          type: string
          format: uuid
        stream_type:
          type: string
          enum: [organization]
        event_type:
          type: string
          enum: [organization.reactivated]

    # Bootstrap Event Schemas
    OrganizationBootstrapInitiatedEvent:
      type: object
      required:
        - stream_id
        - stream_type
        - event_type
        - event_data
        - event_metadata
      properties:
        stream_id:
          type: string
          format: uuid
          description: Organization UUID (generated for new org)
        stream_type:
          type: string
          enum: [organization]
        event_type:
          type: string
          enum: [organization.bootstrap.initiated]
        event_data:
          $ref: '#/components/schemas/OrganizationBootstrapInitiationData'
        event_metadata:
          $ref: '../components/schemas.yaml#/components/schemas/EventMetadata'

    OrganizationBootstrapInitiationData:
      type: object
      required:
        - organization_type
        - organization_name
        - admin_email
        - bootstrap_id
      properties:
        bootstrap_id:
          type: string
          format: uuid
          description: Unique identifier for this bootstrap process (for tracking)
        organization_type:
          type: string
          enum: [provider, provider_partner]
          description: Type of organization being bootstrapped
        organization_name:
          type: string
          maxLength: 200
          description: Human-readable organization name
          examples:
            - "ACME Healthcare Services"
            - "XYZ Consulting Partners"
        admin_email:
          type: string
          format: email
          description: Email address for the initial organization administrator
          examples:
            - "admin@acmehealthcare.com"
            - "director@xyzconsulting.com"
        slug:
          type: string
          pattern: '^[a-z0-9_]+$'
          description: URL-safe organization identifier (auto-generated if not provided)
          examples:
            - "acme_healthcare"
            - "xyz_consulting"
        contact_info:
          type: object
          description: Optional contact information for the organization
          properties:
            phone_number:
              type: string
            timezone:
              type: string
              default: "America/New_York"

    OrganizationBootstrapCompletedEvent:
      type: object
      required:
        - stream_id
        - stream_type
        - event_type
        - event_data
        - event_metadata
      properties:
        stream_id:
          type: string
          format: uuid
        stream_type:
          type: string
          enum: [organization]
        event_type:
          type: string
          enum: [organization.bootstrap.completed]
        event_data:
          $ref: '#/components/schemas/OrganizationBootstrapCompletionData'
        event_metadata:
          $ref: '../components/schemas.yaml#/components/schemas/EventMetadata'

    OrganizationBootstrapCompletionData:
      type: object
      required:
        - bootstrap_id
        - organization_id
        - admin_role_assigned
        - permissions_granted
      properties:
        bootstrap_id:
          type: string
          format: uuid
        organization_id:
          type: string
          format: uuid
        admin_role_assigned:
          type: string
          enum: [provider_admin, partner_admin]
          description: Role assigned to the initial administrator
        permissions_granted:
          type: integer
          description: Number of permissions granted to the admin role
        ltree_path:
          type: string
          description: Organization ltree path in hierarchy
          examples:
            - "root.org_acme_healthcare"

    OrganizationBootstrapFailedEvent:
      type: object
      required:
        - stream_id
        - stream_type
        - event_type
        - event_data
        - event_metadata
      properties:
        stream_id:
          type: string
          format: uuid
        stream_type:
          type: string
          enum: [organization]
        event_type:
          type: string
          enum: [organization.bootstrap.failed]
        event_data:
          $ref: '#/components/schemas/OrganizationBootstrapFailureData'
        event_metadata:
          $ref: '../components/schemas.yaml#/components/schemas/EventMetadata'

    OrganizationBootstrapFailureData:
      type: object
      required:
        - bootstrap_id
        - failure_stage
        - error_message
      properties:
        bootstrap_id:
          type: string
          format: uuid
        failure_stage:
          type: string
          enum: [organization_creation, dns_provisioning, admin_user_creation, role_assignment, permission_grants, invitation_email]
          description: Stage where bootstrap process failed
        error_message:
          type: string
          description: Error details for troubleshooting
        partial_cleanup_required:
          type: boolean
          description: Whether partial resources need cleanup
          default: false

    OrganizationBootstrapCancelledEvent:
      type: object
      required:
        - stream_id
        - stream_type
        - event_type
        - event_data
        - event_metadata
      properties:
        stream_id:
          type: string
          format: uuid
        stream_type:
          type: string
          enum: [organization]
        event_type:
          type: string
          enum: [organization.bootstrap.cancelled]
        event_data:
          $ref: '#/components/schemas/OrganizationBootstrapCancellationData'
        event_metadata:
          $ref: '../components/schemas.yaml#/components/schemas/EventMetadata'

    OrganizationBootstrapCancellationData:
      type: object
      required:
        - bootstrap_id
        - cleanup_completed
      properties:
        bootstrap_id:
          type: string
          format: uuid
        cleanup_completed:
          type: boolean
          description: Whether all partial resources were successfully cleaned up
        cleanup_actions:
          type: array
          items:
            type: string
          description: List of cleanup actions performed
          examples:
            - "removed_dns_records"
            - "removed_partial_database_records"
            - "deleted_pending_invitations"
        original_failure_stage:
          type: string
          description: Original stage where bootstrap failed

    # Subdomain Provisioning Event Schemas
    OrganizationSubdomainDnsCreatedEvent:
      type: object
      required:
        - stream_id
        - stream_type
        - event_type
        - event_data
        - event_metadata
      properties:
        stream_id:
          type: string
          format: uuid
          description: Organization UUID
        stream_type:
          type: string
          enum: [organization]
        event_type:
          type: string
          enum: [organization.subdomain.dns_created]
        event_data:
          $ref: '#/components/schemas/SubdomainDnsCreatedData'
        event_metadata:
          $ref: '../components/schemas.yaml#/components/schemas/EventMetadata'

    SubdomainDnsCreatedData:
      type: object
      required:
        - subdomain
        - cloudflare_record_id
        - dns_record_type
        - dns_record_value
      properties:
        subdomain:
          type: string
          description: Subdomain name (e.g., "acme-healthcare")
          examples:
            - "acme-healthcare"
            - "poc-test1-20251212"
        cloudflare_record_id:
          type: string
          description: Cloudflare DNS record ID
        cloudflare_zone_id:
          type: string
          description: Cloudflare zone ID
        dns_record_type:
          type: string
          enum: [CNAME, A]
          description: DNS record type
        dns_record_value:
          type: string
          description: DNS record target value
          examples:
            - "a4c.firstovertheline.com"

    OrganizationSubdomainVerifiedEvent:
      type: object
      required:
        - stream_id
        - stream_type
        - event_type
        - event_data
        - event_metadata
      properties:
        stream_id:
          type: string
          format: uuid
          description: Organization UUID
        stream_type:
          type: string
          enum: [organization]
        event_type:
          type: string
          enum: [organization.subdomain.verified]
        event_data:
          $ref: '#/components/schemas/SubdomainVerifiedData'
        event_metadata:
          $ref: '../components/schemas.yaml#/components/schemas/EventMetadata'

    SubdomainVerifiedData:
      type: object
      required:
        - domain
        - verified
        - verified_at
      properties:
        domain:
          type: string
          description: Full domain that was verified
          examples:
            - "acme-healthcare.firstovertheline.com"
        verified:
          type: boolean
          description: Whether DNS verification succeeded
        verified_at:
          type: string
          format: date-time
          description: Timestamp when verification completed
        verification_method:
          type: string
          enum: [dns_lookup, mock, development]
          description: Method used for verification
        verification_attempts:
          type: integer
          description: Number of verification attempts made
        mode:
          type: string
          enum: [production, development, mock]
          description: Workflow execution mode

    OrganizationSubdomainVerificationFailedEvent:
      type: object
      required:
        - stream_id
        - stream_type
        - event_type
        - event_data
        - event_metadata
      properties:
        stream_id:
          type: string
          format: uuid
          description: Organization UUID
        stream_type:
          type: string
          enum: [organization]
        event_type:
          type: string
          enum: [organization.subdomain.verification_failed]
        event_data:
          $ref: '#/components/schemas/SubdomainVerificationFailedData'
        event_metadata:
          $ref: '../components/schemas.yaml#/components/schemas/EventMetadata'

    SubdomainVerificationFailedData:
      type: object
      required:
        - domain
        - failure_reason
      properties:
        domain:
          type: string
          description: Full domain that failed verification
        failure_reason:
          type: string
          description: Reason for verification failure
          examples:
            - "DNS_TIMEOUT"
            - "CNAME_NOT_FOUND"
            - "WRONG_TARGET"
        retry_count:
          type: integer
          description: Number of retries attempted
        will_retry:
          type: boolean
          description: Whether verification will be retried