components:
  messages:
    PermissionDefined:
      name: permission.defined
      title: Permission Defined
      summary: A new permission has been created in the system
      contentType: application/json
      payload:
        $ref: '#/components/schemas/PermissionDefinedEvent'

    PermissionUpdated:
      name: permission.updated
      title: Permission Updated
      summary: An existing permission's mutable fields have been updated
      contentType: application/json
      payload:
        $ref: '#/components/schemas/PermissionUpdatedEvent'

    RoleCreated:
      name: role.created
      title: Role Created
      summary: A new role has been created
      contentType: application/json
      payload:
        $ref: '#/components/schemas/RoleCreatedEvent'

    RolePermissionGranted:
      name: role.permission.granted
      title: Role Permission Granted
      summary: A permission has been granted to a role
      contentType: application/json
      payload:
        $ref: '#/components/schemas/RolePermissionGrantedEvent'

    RolePermissionRevoked:
      name: role.permission.revoked
      title: Role Permission Revoked
      summary: A permission has been revoked from a role
      contentType: application/json
      payload:
        $ref: '#/components/schemas/RolePermissionRevokedEvent'

    RoleUpdated:
      name: role.updated
      title: Role Updated
      summary: A role's name or description has been updated
      contentType: application/json
      payload:
        $ref: '#/components/schemas/RoleUpdatedEvent'

    RoleDeactivated:
      name: role.deactivated
      title: Role Deactivated
      summary: A role has been deactivated (frozen)
      contentType: application/json
      payload:
        $ref: '#/components/schemas/RoleDeactivatedEvent'

    RoleReactivated:
      name: role.reactivated
      title: Role Reactivated
      summary: A role has been reactivated
      contentType: application/json
      payload:
        $ref: '#/components/schemas/RoleReactivatedEvent'

    RoleDeleted:
      name: role.deleted
      title: Role Deleted
      summary: A role has been soft-deleted
      contentType: application/json
      payload:
        $ref: '#/components/schemas/RoleDeletedEvent'

    UserRoleAssigned:
      name: user.role.assigned
      title: User Role Assigned
      summary: A role has been assigned to a user
      contentType: application/json
      payload:
        $ref: '#/components/schemas/UserRoleAssignedEvent'

    UserRoleRevoked:
      name: user.role.revoked
      title: User Role Revoked
      summary: A role has been revoked from a user
      contentType: application/json
      payload:
        $ref: '#/components/schemas/UserRoleRevokedEvent'

    AccessGrantCreated:
      name: access_grant.created
      title: Access Grant Created
      summary: A cross-tenant access grant has been created
      contentType: application/json
      payload:
        $ref: '#/components/schemas/AccessGrantCreatedEvent'

    AccessGrantRevoked:
      name: access_grant.revoked
      title: Access Grant Revoked
      summary: A cross-tenant access grant has been revoked
      contentType: application/json
      payload:
        $ref: '#/components/schemas/AccessGrantRevokedEvent'

  schemas:
    # ============================================================================
    # Event Data Schemas
    # ============================================================================

    PermissionDefinedData:
      title: PermissionDefinedData
      type: object
      required:
        - applet
        - action
        - description
        - scope_type
        - requires_mfa
      properties:
        applet:
          type: string
          description: Functional module (medication, provider, client, etc.)
          examples:
            - medication
            - provider
            - client
            - user
        action:
          type: string
          description: Specific capability within the applet
          examples:
            - create
            - view
            - update
            - delete
            - approve
            - impersonate
        description:
          type: string
          description: Human-readable explanation of the permission
          examples:
            - Create new medication prescriptions
            - View client records
            - Impersonate users for support operations
        scope_type:
          $ref: ../components/enums.yaml#/components/schemas/ScopeType
        requires_mfa:
          type: boolean
          description: Whether MFA is required to use this permission
          default: false

    RoleCreatedData:
      title: RoleCreatedData
      type: object
      required:
        - name
        - description
      properties:
        name:
          type: string
          description: Role identifier
          examples:
            - super_admin
            - provider_admin
            - facility_admin
            - clinician
        description:
          type: string
          description: Human-readable role description
          examples:
            - Platform-wide administrator with all permissions
            - Organization administrator with org-scoped permissions
        zitadel_org_id:
          type: string
          nullable: true
          description: Zitadel organization ID (NULL for super_admin)
        org_hierarchy_scope:
          type: string
          nullable: true
          description: ltree path for hierarchical scoping (NULL for super_admin)
          examples:
            - org_acme_healthcare_001
            - org_acme_healthcare_001.facility_456
        display_name:
          type: string
          nullable: true
          description: Human-readable display name for the role
          examples:
            - Provider Administrator
            - Facility Manager
            - Clinician
        organization_id:
          type: string
          format: uuid
          nullable: true
          description: Organization UUID for org-scoped roles (NULL for super_admin)
        scope:
          $ref: ../components/enums.yaml#/components/schemas/RoleScope
        is_system_role:
          type: boolean
          nullable: true
          description: Whether this is a system-defined role (not user-created)
          default: false

    RolePermissionGrantedData:
      title: RolePermissionGrantedData
      type: object
      required:
        - permission_id
        - permission_name
      properties:
        permission_id:
          type: string
          format: uuid
          description: UUID of the permission being granted
        permission_name:
          type: string
          description: Full permission identifier (for logging)
          pattern: '^[a-z_]+\.[a-z_]+$'
          examples:
            - medication.create
            - provider.impersonate
            - client.view

    RolePermissionRevokedData:
      title: RolePermissionRevokedData
      type: object
      required:
        - permission_id
        - permission_name
        - revocation_reason
      properties:
        permission_id:
          type: string
          format: uuid
        permission_name:
          type: string
          pattern: '^[a-z_]+\.[a-z_]+$'
        revocation_reason:
          type: string
          description: Explanation for permission removal

    RoleUpdatedData:
      title: RoleUpdatedData
      type: object
      properties:
        name:
          type: string
          description: Updated role name (if changed)
          examples:
            - provider_admin
            - facility_admin
            - custom_clinician
        description:
          type: string
          description: Updated role description (if changed)
          examples:
            - Organization administrator with org-scoped permissions
            - Facility-specific administrative role

    RoleDeactivatedData:
      title: RoleDeactivatedData
      type: object
      required:
        - reason
      properties:
        reason:
          type: string
          description: Reason for deactivation
          examples:
            - Role no longer needed for current organizational structure
            - Temporarily freezing role for security review

    RoleReactivatedData:
      title: RoleReactivatedData
      type: object
      properties:
        reason:
          type: string
          description: Reason for reactivation
          examples:
            - Security review completed, role reinstated
            - Role needed again for new hire onboarding

    RoleDeletedData:
      title: RoleDeletedData
      type: object
      required:
        - reason
      properties:
        reason:
          type: string
          description: Reason for deletion
          examples:
            - Role permanently removed after deprecation period
            - Custom role no longer needed

    UserRoleAssignedData:
      title: UserRoleAssignedData
      type: object
      required:
        - role_id
        - role_name
        - org_id
        - scope_path
        - assigned_by
      properties:
        role_id:
          type: string
          format: uuid
          description: UUID of the role being assigned
        role_name:
          type: string
          description: Role identifier for logging
          examples:
            - super_admin
            - provider_admin
        org_id:
          type: string
          description: Organization ID ('*' for super_admin, specific org for others)
          examples:
            - '*'
            - acme_healthcare_001
        scope_path:
          type: string
          description: ltree hierarchy path ('*' for global, specific path for scoped)
          examples:
            - '*'
            - org_acme_healthcare_001
            - org_acme_healthcare_001.facility_456
        assigned_by:
          type: string
          format: uuid
          description: User who performed the assignment

    UserRoleRevokedData:
      title: UserRoleRevokedData
      type: object
      required:
        - role_id
        - role_name
        - org_id
        - revoked_by
      properties:
        role_id:
          type: string
          format: uuid
        role_name:
          type: string
        org_id:
          type: string
        revoked_by:
          type: string
          format: uuid
          description: User who performed the revocation

    AccessGrantCreatedData:
      title: AccessGrantCreatedData
      type: object
      required:
        - consultant_org_id
        - provider_org_id
        - scope
        - authorization_type
      properties:
        consultant_org_id:
          type: string
          description: Provider Partner organization ID
        consultant_user_id:
          type: string
          format: uuid
          nullable: true
          description: Specific user (NULL for org-wide grant)
        provider_org_id:
          type: string
          description: Target Provider organization ID
        scope:
          $ref: ../components/enums.yaml#/components/schemas/GrantScope
        scope_id:
          type: string
          format: uuid
          nullable: true
          description: Specific resource ID if scoped
        authorization_type:
          $ref: ../components/enums.yaml#/components/schemas/GrantAuthorizationType
        legal_reference:
          type: string
          nullable: true
          description: Court order number, consent form ID, contract reference
          examples:
            - Court Order #2024-1234
            - Parental Consent Form #PC-5678
            - VAR Contract #VAR-2024-001
        expires_at:
          type: string
          format: date-time
          nullable: true
          description: Expiration timestamp for time-limited access

    PermissionUpdatedData:
      title: PermissionUpdatedData
      type: object
      properties:
        description:
          type: string
          description: Updated human-readable explanation of the permission
        scope_type:
          $ref: ../components/enums.yaml#/components/schemas/ScopeType
        requires_mfa:
          type: boolean
          description: Updated MFA requirement flag

    AccessGrantRevokedData:
      title: AccessGrantRevokedData
      type: object
      required:
        - grant_id
        - revoked_by
        - revocation_reason
      properties:
        grant_id:
          type: string
          format: uuid
          description: UUID of the grant being revoked
        revoked_by:
          type: string
          format: uuid
          description: User who revoked the grant
        revocation_reason:
          type: string
          description: Explanation for revocation
          examples:
            - Court case closed, access no longer required
            - VAR contract terminated
            - Parental custody changed, consent withdrawn

    # ============================================================================
    # Event Schemas
    # ============================================================================

    PermissionDefinedEvent:
      title: PermissionDefinedEvent
      type: object
      required:
        - stream_id
        - stream_type
        - event_type
        - event_data
        - event_metadata
      properties:
        stream_id:
          type: string
          format: uuid
          description: Permission UUID
        stream_type:
          type: string
          const: permission
        event_type:
          type: string
          const: permission.defined
        event_data:
          $ref: '#/components/schemas/PermissionDefinedData'
        event_metadata:
          $ref: '../components/schemas.yaml#/components/schemas/EventMetadata'

    PermissionUpdatedEvent:
      title: PermissionUpdatedEvent
      type: object
      required:
        - stream_id
        - stream_type
        - event_type
        - event_data
        - event_metadata
      properties:
        stream_id:
          type: string
          format: uuid
          description: Permission UUID
        stream_type:
          type: string
          const: permission
        event_type:
          type: string
          const: permission.updated
        event_data:
          $ref: '#/components/schemas/PermissionUpdatedData'
        event_metadata:
          $ref: '../components/schemas.yaml#/components/schemas/EventMetadata'

    RoleCreatedEvent:
      title: RoleCreatedEvent
      type: object
      required:
        - stream_id
        - stream_type
        - event_type
        - event_data
        - event_metadata
      properties:
        stream_id:
          type: string
          format: uuid
          description: Role UUID
        stream_type:
          type: string
          const: role
        event_type:
          type: string
          const: role.created
        event_data:
          $ref: '#/components/schemas/RoleCreatedData'
        event_metadata:
          $ref: '../components/schemas.yaml#/components/schemas/EventMetadata'

    RolePermissionGrantedEvent:
      title: RolePermissionGrantedEvent
      type: object
      required:
        - stream_id
        - stream_type
        - event_type
        - event_data
        - event_metadata
      properties:
        stream_id:
          type: string
          format: uuid
          description: Role UUID
        stream_type:
          type: string
          const: role
        event_type:
          type: string
          const: role.permission.granted
        event_data:
          $ref: '#/components/schemas/RolePermissionGrantedData'
        event_metadata:
          $ref: '../components/schemas.yaml#/components/schemas/EventMetadata'

    RolePermissionRevokedEvent:
      title: RolePermissionRevokedEvent
      type: object
      required:
        - stream_id
        - stream_type
        - event_type
        - event_data
        - event_metadata
      properties:
        stream_id:
          type: string
          format: uuid
          description: Role UUID
        stream_type:
          type: string
          const: role
        event_type:
          type: string
          const: role.permission.revoked
        event_data:
          $ref: '#/components/schemas/RolePermissionRevokedData'
        event_metadata:
          $ref: '../components/schemas.yaml#/components/schemas/EventMetadata'

    RoleUpdatedEvent:
      title: RoleUpdatedEvent
      type: object
      required:
        - stream_id
        - stream_type
        - event_type
        - event_data
        - event_metadata
      properties:
        stream_id:
          type: string
          format: uuid
          description: Role UUID
        stream_type:
          type: string
          const: role
        event_type:
          type: string
          const: role.updated
        event_data:
          $ref: '#/components/schemas/RoleUpdatedData'
        event_metadata:
          $ref: '../components/schemas.yaml#/components/schemas/EventMetadata'

    RoleDeactivatedEvent:
      title: RoleDeactivatedEvent
      type: object
      required:
        - stream_id
        - stream_type
        - event_type
        - event_data
        - event_metadata
      properties:
        stream_id:
          type: string
          format: uuid
          description: Role UUID
        stream_type:
          type: string
          const: role
        event_type:
          type: string
          const: role.deactivated
        event_data:
          $ref: '#/components/schemas/RoleDeactivatedData'
        event_metadata:
          $ref: '../components/schemas.yaml#/components/schemas/EventMetadata'

    RoleReactivatedEvent:
      title: RoleReactivatedEvent
      type: object
      required:
        - stream_id
        - stream_type
        - event_type
        - event_data
        - event_metadata
      properties:
        stream_id:
          type: string
          format: uuid
          description: Role UUID
        stream_type:
          type: string
          const: role
        event_type:
          type: string
          const: role.reactivated
        event_data:
          $ref: '#/components/schemas/RoleReactivatedData'
        event_metadata:
          $ref: '../components/schemas.yaml#/components/schemas/EventMetadata'

    RoleDeletedEvent:
      title: RoleDeletedEvent
      type: object
      required:
        - stream_id
        - stream_type
        - event_type
        - event_data
        - event_metadata
      properties:
        stream_id:
          type: string
          format: uuid
          description: Role UUID
        stream_type:
          type: string
          const: role
        event_type:
          type: string
          const: role.deleted
        event_data:
          $ref: '#/components/schemas/RoleDeletedData'
        event_metadata:
          $ref: '../components/schemas.yaml#/components/schemas/EventMetadata'

    UserRoleAssignedEvent:
      title: UserRoleAssignedEvent
      type: object
      required:
        - stream_id
        - stream_type
        - event_type
        - event_data
        - event_metadata
      properties:
        stream_id:
          type: string
          format: uuid
          description: User UUID
        stream_type:
          type: string
          const: user
        event_type:
          type: string
          const: user.role.assigned
        event_data:
          $ref: '#/components/schemas/UserRoleAssignedData'
        event_metadata:
          $ref: '../components/schemas.yaml#/components/schemas/EventMetadata'

    UserRoleRevokedEvent:
      title: UserRoleRevokedEvent
      type: object
      required:
        - stream_id
        - stream_type
        - event_type
        - event_data
        - event_metadata
      properties:
        stream_id:
          type: string
          format: uuid
          description: User UUID
        stream_type:
          type: string
          const: user
        event_type:
          type: string
          const: user.role.revoked
        event_data:
          $ref: '#/components/schemas/UserRoleRevokedData'
        event_metadata:
          $ref: '../components/schemas.yaml#/components/schemas/EventMetadata'

    AccessGrantCreatedEvent:
      title: AccessGrantCreatedEvent
      type: object
      required:
        - stream_id
        - stream_type
        - event_type
        - event_data
        - event_metadata
      properties:
        stream_id:
          type: string
          format: uuid
          description: Access grant UUID
        stream_type:
          type: string
          const: access_grant
        event_type:
          type: string
          const: access_grant.created
        event_data:
          $ref: '#/components/schemas/AccessGrantCreatedData'
        event_metadata:
          $ref: '../components/schemas.yaml#/components/schemas/EventMetadata'

    AccessGrantRevokedEvent:
      title: AccessGrantRevokedEvent
      type: object
      required:
        - stream_id
        - stream_type
        - event_type
        - event_data
        - event_metadata
      properties:
        stream_id:
          type: string
          format: uuid
          description: Access grant UUID
        stream_type:
          type: string
          const: access_grant
        event_type:
          type: string
          const: access_grant.revoked
        event_data:
          $ref: '#/components/schemas/AccessGrantRevokedData'
        event_metadata:
          $ref: '../components/schemas.yaml#/components/schemas/EventMetadata'
