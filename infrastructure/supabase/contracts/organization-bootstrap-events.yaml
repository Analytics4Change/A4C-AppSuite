asyncapi: '2.6.0'
info:
  title: Organization Bootstrap Domain Events
  version: 1.0.0
  description: |
    Events emitted during organization bootstrap workflow.

    Event Flow:
    1. organization.bootstrap.initiated - Edge Function receives bootstrap request
    2. organization.bootstrap.workflow_started - Event listener starts Temporal workflow
    3. organization.created - Workflow activity creates organization
    4. organization.bootstrap.completed - Workflow completes successfully

    See: documentation/infrastructure/reference/events/

channels:
  organization.bootstrap.initiated:
    description: |
      Emitted when Edge Function receives organization bootstrap request.
      Triggers event listener to start Temporal workflow via PostgreSQL NOTIFY.
    publish:
      message:
        $ref: '#/components/messages/OrganizationBootstrapInitiated'

  organization.bootstrap.workflow_started:
    description: |
      Emitted when event listener successfully starts Temporal workflow.
      Provides audit trail linking domain events to workflow executions.
      Maintains event sourcing immutability (no updates to bootstrap.initiated event).
    publish:
      message:
        $ref: '#/components/messages/OrganizationBootstrapWorkflowStarted'

components:
  messages:
    OrganizationBootstrapInitiated:
      name: OrganizationBootstrapInitiated
      title: Organization Bootstrap Initiated
      summary: Bootstrap process started for new organization
      contentType: application/json
      payload:
        type: object
        required:
          - subdomain
          - orgData
          - users
        properties:
          subdomain:
            type: string
            pattern: '^[a-z0-9-]+$'
            description: Custom subdomain for the organization (triggers DNS provisioning)
            example: "acme-healthcare"
          orgData:
            type: object
            required:
              - name
              - type
              - contacts
              - addresses
              - phones
            description: Organization configuration and metadata
            properties:
              name:
                type: string
                description: Display name for the organization
                example: "Acme Healthcare"
              type:
                type: string
                enum: [provider, partner]
                description: Type of organization being created
              parentOrgId:
                type: string
                format: uuid
                nullable: true
                description: Parent organization ID (required for partners, optional for providers)
              contacts:
                type: array
                description: Contact information (at least one contact required)
                minItems: 1
                items:
                  type: object
                  required:
                    - firstName
                    - lastName
                    - email
                    - type
                    - label
                  properties:
                    firstName:
                      type: string
                      description: Contact first name
                      example: "John"
                    lastName:
                      type: string
                      description: Contact last name
                      example: "Doe"
                    email:
                      type: string
                      format: email
                      description: Contact email address
                      example: "john.doe@acme.com"
                    title:
                      type: string
                      nullable: true
                      description: Contact job title
                      example: "Director of Operations"
                    department:
                      type: string
                      nullable: true
                      description: Contact department
                      example: "Operations"
                    type:
                      type: string
                      description: Contact type identifier from contact_type enum
                      example: "billing_contact"
                    label:
                      type: string
                      description: Human-readable label for this contact
                      example: "Billing Contact"
              addresses:
                type: array
                description: Address information (at least one address required)
                minItems: 1
                items:
                  type: object
                  required:
                    - street1
                    - city
                    - state
                    - zipCode
                    - type
                    - label
                  properties:
                    street1:
                      type: string
                      description: Street address line 1
                      example: "123 Main St"
                    street2:
                      type: string
                      nullable: true
                      description: Street address line 2 (suite, apt, etc.)
                      example: "Suite 200"
                    city:
                      type: string
                      description: City name
                      example: "Springfield"
                    state:
                      type: string
                      description: State code (2 letters)
                      example: "IL"
                    zipCode:
                      type: string
                      description: ZIP or postal code
                      example: "62701"
                    type:
                      type: string
                      description: Address type identifier from address_type enum
                      example: "billing_address"
                    label:
                      type: string
                      description: Human-readable label for this address
                      example: "Billing Address"
              phones:
                type: array
                description: Phone information (at least one phone required)
                minItems: 1
                items:
                  type: object
                  required:
                    - number
                    - type
                    - label
                  properties:
                    number:
                      type: string
                      description: Phone number (formatted or unformatted)
                      example: "(555) 123-4567"
                    extension:
                      type: string
                      nullable: true
                      description: Phone extension
                      example: "1234"
                    type:
                      type: string
                      description: Phone type identifier from phone_type enum
                      example: "billing_phone"
                    label:
                      type: string
                      description: Human-readable label for this phone
                      example: "Billing Phone"
              partnerType:
                type: string
                enum: [var, family, court, other]
                nullable: true
                description: Partner type (required when type='partner')
              referringPartnerId:
                type: string
                format: uuid
                nullable: true
                description: Referring partner organization ID (optional)
          users:
            type: array
            description: List of users to invite after organization creation (derived from provider admin contact)
            items:
              type: object
              required:
                - email
                - firstName
                - lastName
                - role
              properties:
                email:
                  type: string
                  format: email
                  description: User email address
                  example: "admin@acme.com"
                firstName:
                  type: string
                  description: User first name
                  example: "John"
                lastName:
                  type: string
                  description: User last name
                  example: "Doe"
                role:
                  type: string
                  enum: [super_admin, org_admin, provider_admin, clinician, case_manager, viewer]
                  description: User role within organization
                  example: "super_admin"

    OrganizationBootstrapWorkflowStarted:
      name: OrganizationBootstrapWorkflowStarted
      title: Organization Bootstrap Workflow Started
      summary: Temporal workflow started for organization bootstrap
      contentType: application/json
      payload:
        type: object
        required:
          - bootstrap_event_id
          - workflow_id
          - workflow_run_id
          - workflow_type
        properties:
          bootstrap_event_id:
            type: string
            format: uuid
            description: ID of the organization.bootstrap.initiated event that triggered this workflow
            example: "b8309521-a46f-4d71-becb-1f138878425b"
          workflow_id:
            type: string
            description: Deterministic Temporal workflow ID (format org-bootstrap-{stream_id})
            example: "org-bootstrap-d8846196-8f69-46dc-af9a-87a57843c4e4"
          workflow_run_id:
            type: string
            description: Temporal workflow execution run ID (unique per execution)
            example: "019ab7a4-a6bf-70a3-8394-7b09371e98ba"
          workflow_type:
            type: string
            description: Temporal workflow type name
            example: "organizationBootstrapWorkflow"
