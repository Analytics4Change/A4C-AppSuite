# Context: Provider Admin Post-Invitation UX

## Decision Record

**Date**: 2025-11-20
**Feature**: Provider Admin Post-Invitation Onboarding Flow
**Goal**: Enable provider_admin users to self-serve organizational setup after accepting invitations, including defining internal OU hierarchy and custom roles, via a blocking setup wizard that ensures proper system initialization.

### Key Decisions

1. **Blocking Setup Wizard (Required)**:
   - **Decision**: User MUST complete wizard before accessing main application
   - **Rationale**: Ensures data quality, prevents incomplete setups, guides users through critical initial configuration
   - **Alternative Considered**: Optional wizard with soft prompts - Rejected due to risk of users skipping essential setup
   - **Impact**: Higher initial friction, but better long-term user success

2. **Minimal OU Setup (Optional, 0+ OUs)**:
   - **Decision**: OU creation is optional during wizard (can skip, create later)
   - **Rationale**: Balances onboarding speed with flexibility; not all orgs have complex hierarchies
   - **Alternative Considered**: Require at least 1 OU - Rejected as too restrictive for small providers
   - **Impact**: Faster onboarding, but some users may never define proper structure

3. **Separate Routes: `/organizations` vs `/organization-units`**:
   - **Decision**: Platform owners use `/organizations` (plural), provider admins use `/organization-units` for OU management
   - **Rationale**: Clear semantic separation, no role-based conditional logic complexity
   - **Alternative Considered**: Overload `/organizations` with role-based rendering - Rejected due to complexity
   - **Impact**: Cleaner codebase, easier to maintain, clear mental model
   - **Note**: Updated 2025-12-08 to align with active organization-units plan

4. **Custom Role Creation (Permission Selection UI)**:
   - **Decision**: Wizard allows creating custom roles with full permission selection
   - **Rationale**: Providers need org-specific roles (e.g., "Senior Nurse Practitioner" with custom permissions)
   - **Alternative Considered**: Use only global role templates - Rejected as insufficiently flexible
   - **Impact**: More complex UI, but empowers providers to define precise access controls

5. **Subdomain Routing Deferred to Phase 2**:
   - **Decision**: MVP uses path-based routing; subdomain routing (`https://{subdomain}.firstovertheline.com`) deferred
   - **Rationale**: Subdomain routing requires 5-7 days infrastructure work (wildcard DNS, TLS, nginx config)
   - **Alternative Considered**: Implement subdomain routing immediately - Rejected due to timeline
   - **Impact**: Simpler MVP, can add subdomain routing later without UX changes (additive feature)

6. **Wizard-Guided Navigation (Dynamic Redirect)**:
   - **Decision**: Wizard completion redirects based on user actions during wizard
   - **Rationale**: Provides natural next step based on what user created (OUs → structure, roles → users)
   - **Alternative Considered**: Always redirect to dashboard - Rejected as generic, loses context
   - **Impact**: Better UX flow, users land where they need to continue work

7. **Role Assignment Deferred (Post-User Creation)**:
   - **Decision**: Role assignment happens AFTER users are created, not during wizard
   - **Rationale**: Provider admins have all permissions, so they don't need additional roles for themselves
   - **Alternative Considered**: Require role assignment in wizard - Rejected as unnecessary for provider_admin
   - **Impact**: Simpler wizard, fewer steps

8. **Professional Email Design (No Purple Gradient)**:
   - **Decision**: Redesign invitation email to look professional, not AI-generated
   - **Rationale**: User feedback: purple gradient "screams generated by AI"
   - **Alternative Considered**: Keep existing design - Rejected due to unprofessional appearance
   - **Impact**: Better brand perception, higher trust

## Technical Context

### Architecture

This feature is the **first time provider admins (non-platform owners) get organizational management features**. Previously, only super_admins and partner_onboarders could manage organizations.

**System Architecture**:
```
┌─────────────────────────────────────────────────────────────────┐
│                    User Journey Flow                             │
├─────────────────────────────────────────────────────────────────┤
│ 1. Email Invitation (Temporal workflow sends email)             │
│    ↓                                                             │
│ 2. Click Link → /organizations/invitation?token=...             │
│    ↓                                                             │
│ 3. Token Validation (Supabase Edge Function)                    │
│    ↓                                                             │
│ 4. Create Account (Email/Password OR Google OAuth)              │
│    ↓                                                             │
│ 5. Supabase Auth Issues JWT (with custom claims: org_id, role)  │
│    ↓                                                             │
│ 6. First-Time Login Detection (setup_completed_at IS NULL)      │
│    ↓                                                             │
│ 7. BLOCKING SETUP WIZARD (cannot skip)                          │
│    ├── Step 1: Confirm Org Details                              │
│    ├── Step 2: Accept Data Usage Agreements (HIPAA, ToS)        │
│    ├── Step 3: Create OUs (optional, 0+)                        │
│    └── Step 4: Create Custom Roles (optional, 0+)               │
│    ↓                                                             │
│ 8. Wizard Completion → Redirect (based on state)                │
│    ├── OUs created → /organization-units                        │
│    ├── Roles created → /organization/users                      │
│    ├── Both → /organization/users                               │
│    └── Neither → /dashboard                                     │
│    ↓                                                             │
│ 9. Full App Access (provider_admin permissions)                 │
└─────────────────────────────────────────────────────────────────┘
```

**Multi-Tenant Isolation**:
- JWT custom claims include `org_id`, `user_role`, `permissions`, `scope_path`
- PostgreSQL RLS policies enforce org isolation automatically
- Provider admins can only access data within their organization
- Subdomain routing (future) adds visual isolation layer

**Event-Driven Architecture**:
- All state changes emit domain events (CQRS pattern)
- OU creation → `OrganizationCreated` event
- Role creation → `RoleCreated` event
- Wizard completion → `SetupWizardCompleted` event
- Events update CQRS projections via PostgreSQL triggers

### Tech Stack

**Frontend**:
- **Framework**: React 19 + TypeScript
- **Routing**: React Router v6
- **State Management**: MobX (reactive stores with `observer()` HOC)
- **UI Components**: Radix UI primitives (Dialog, DropdownMenu, Select)
- **Styling**: Tailwind CSS + class-variance-authority (CVA)
- **Forms**: React Hook Form + Zod validation
- **Persistence**: localStorage (wizard progress auto-save)

**Backend**:
- **Orchestration**: Temporal.io workflows (durable, event-sourced)
- **Database**: PostgreSQL 15 with ltree extension (hierarchical OUs)
- **Auth**: Supabase Auth (OAuth2 PKCE, SAML 2.0)
- **RLS**: Row-Level Security policies (multi-tenant isolation)
- **API**: Supabase Edge Functions (Deno runtime)

**Infrastructure**:
- **Container**: Docker (nginx-based frontend)
- **Registry**: GitHub Container Registry (GHCR)
- **Orchestration**: Kubernetes (k3s cluster)
- **Ingress**: Traefik with Let's Encrypt TLS
- **DNS**: Cloudflare API (subdomain provisioning)

### Dependencies

**Existing Features This Builds On**:
1. **Organization Bootstrap Workflow** (`workflows/src/workflows/organization-bootstrap/`):
   - Creates organizations, provisions DNS, sends invitations
   - Already generates invitation tokens and sends emails
   - **Dependency**: Email template update, URL fix

2. **Invitation Acceptance Page** (`frontend/src/pages/organizations/AcceptInvitationPage.tsx`):
   - Validates tokens, creates user accounts
   - Dual auth methods (email/password, Google OAuth)
   - **Dependency**: Redirect to wizard after account creation

3. **JWT Custom Claims Hook** (`infrastructure/supabase/sql/03-functions/auth/custom-access-token-hook.sql`):
   - Database hook adds org_id, role, permissions to JWT
   - **Dependency**: Ensure provider_admin role has correct permissions

4. **RBAC Architecture** (`infrastructure/supabase/sql/02-tables/rbac/`):
   - Role and permission tables already exist
   - User role assignments with org scoping
   - **Dependency**: RLS policies for provider_admin OU/role management

5. **Organizational Units Schema** (`infrastructure/supabase/sql/02-tables/organizations/001-organizations_projection.sql`):
   - ltree-based hierarchical structure already exists
   - Supports arbitrary depth (depth > 2 = sub-organizations)
   - **Dependency**: Create sub-org workflow, RLS policies

**New Dependencies Introduced**:
1. **Stepper Component**: Multi-step wizard UI (may need to build or import)
2. **Tree View Component**: Visualize OU hierarchy (may use Radix UI or custom)
3. **Permission Selector Component**: Checkbox grid for custom role creation
4. **localStorage Wrapper**: Wizard state persistence utilities

## File Structure

### Existing Files Modified

**Email Template**:
- `workflows/src/activities/organization-bootstrap/send-invitation-emails.ts` (lines 52-99)
  - Remove purple gradient styling
  - Update URL from `/accept-invitation` to `/organizations/invitation`
  - Keep professional structure (greeting, org name, button, expiration)

**Invitation Acceptance**:
- `frontend/src/pages/organizations/AcceptInvitationPage.tsx`
  - Add redirect to wizard after successful account creation (line 396+)
  - Detect first-time login (`setup_completed_at IS NULL`)

**Navigation**:
- `frontend/src/components/layout/MainLayout.tsx` (lines 44-116)
  - Update nav items to show `/organization-units` for provider_admin
  - Hide `/organizations` from provider_admin, show to super_admin only

**Routing**:
- `frontend/src/App.tsx`
  - Add `/onboarding/*` routes for wizard steps
  - Add `/organization-units/*` routes for OU management
  - Add `/organization/users` route for user invitations
  - Add `/organization/roles` route for custom role management

**Auth Context**:
- `frontend/src/contexts/AuthContext.tsx`
  - Check `setup_completed_at` in session claims
  - Redirect to wizard if NULL, allow app access if timestamp

### New Files Created

**Wizard Components**:
- `frontend/src/components/onboarding/SetupWizard.tsx` - Main wizard container with stepper
- `frontend/src/components/onboarding/WelcomeStep.tsx` - Step 1: Org details confirmation
- `frontend/src/components/onboarding/AgreementsStep.tsx` - Step 2: HIPAA/ToS acceptance
- `frontend/src/components/onboarding/OUCreationStep.tsx` - Step 3: Create OUs (optional)
- `frontend/src/components/onboarding/RoleCreationStep.tsx` - Step 4: Create custom roles (optional)

**Wizard Pages**:
- `frontend/src/pages/onboarding/SetupWizardPage.tsx` - Main wizard page (routes to steps)

**Organization Management Components**:
- `frontend/src/components/organization-units/OrganizationTree.tsx` - Hierarchical OU tree visualization
- `frontend/src/components/organization-units/OrganizationTreeNode.tsx` - Tree node component
- `frontend/src/components/organization/RolePermissionSelector.tsx` - Permission checkbox grid
- `frontend/src/components/organization/UserInvitationForm.tsx` - Invite user with role assignment

**Organization Management Pages**:
- `frontend/src/pages/organization-units/OrganizationUnitsListPage.tsx` - OU hierarchy view
- `frontend/src/pages/organization-units/OrganizationUnitsManagePage.tsx` - OU CRUD interface
- `frontend/src/pages/organization/OrganizationUsersPage.tsx` - User list + invitations
- `frontend/src/pages/organization/OrganizationRolesPage.tsx` - Custom role management

**ViewModels (MobX Stores)**:
- `frontend/src/viewModels/onboarding/SetupWizardViewModel.ts` - Wizard state, navigation, auto-save
- `frontend/src/viewModels/organization/OrganizationUnitsViewModel.ts` - OU CRUD operations
- `frontend/src/viewModels/organization/OrganizationUnitFormViewModel.ts` - OU form state
- `frontend/src/viewModels/organization/RoleManagementViewModel.ts` - Custom role CRUD
- `frontend/src/viewModels/organization/UserInvitationViewModel.ts` - User invitation workflow

**Services**:
- `frontend/src/services/organization/IOrganizationUnitService.ts` - OU service interface
- `frontend/src/services/organization/MockOrganizationUnitService.ts` - Mock implementation
- `frontend/src/services/organization/OrganizationUnitServiceFactory.ts` - Factory for DI
- `frontend/src/services/organization/RoleService.ts` - Custom role API calls
- `frontend/src/services/onboarding/SetupWizardService.ts` - Wizard state persistence

**Supabase RPC Functions** (OU CRUD uses direct database calls, not Temporal):
- `infrastructure/supabase/sql/03-functions/organizations/create_organization_unit.sql` - Create OU RPC
- `infrastructure/supabase/sql/03-functions/organizations/update_organization_unit.sql` - Update OU RPC
- `infrastructure/supabase/sql/03-functions/organizations/deactivate_organization_unit.sql` - Deactivate OU RPC
- `infrastructure/supabase/sql/03-functions/organizations/get_organization_units.sql` - List OUs RPC
- **Note**: Temporal is NOT used for OU CRUD (synchronous DB operation). See `dev/active/organization-units-context.md` Decision #7.

**Temporal Workflows** (for complex orchestration only):
- `workflows/src/activities/rbac/create-custom-role.ts` - Create custom role activity
- `workflows/src/activities/rbac/update-role.ts` - Update role permissions activity
- `workflows/src/activities/rbac/delete-role.ts` - Delete role activity (with validation)

**Database Migrations**:
- `infrastructure/supabase/migrations/YYYYMMDDHHMMSS_add_setup_completed_tracking.sql`
  - Add `setup_completed_at` to track wizard completion
- `infrastructure/supabase/migrations/YYYYMMDDHHMMSS_add_ou_management_rls.sql`
  - RLS policies for provider_admin OU management
- `infrastructure/supabase/migrations/YYYYMMDDHHMMSS_add_custom_role_rls.sql`
  - RLS policies for provider_admin custom role management
- `infrastructure/supabase/migrations/YYYYMMDDHHMMSS_create_user_agreements_table.sql`
  - Audit trail for data usage agreement acceptance

## Related Components

**Authentication System**:
- `frontend/src/providers/AuthProvider.tsx` - Auth provider factory (Mock/Integration/Production)
- `frontend/src/services/auth/SupabaseAuthProvider.ts` - Supabase Auth integration
- `infrastructure/supabase/sql/03-functions/auth/custom-access-token-hook.sql` - JWT claims

**RBAC System**:
- `infrastructure/supabase/sql/02-tables/rbac/permissions_projection.sql` - Permission definitions
- `infrastructure/supabase/sql/02-tables/rbac/roles_projection.sql` - Role templates
- `infrastructure/supabase/sql/02-tables/rbac/role_permissions_projection.sql` - Role-permission junction
- `infrastructure/supabase/sql/02-tables/rbac/user_roles_projection.sql` - User role assignments

**Organization Management**:
- `frontend/src/pages/organizations/OrganizationCreatePage.tsx` - Platform owner org creation (super_admin)
- `frontend/src/viewModels/organization/OrganizationFormViewModel.ts` - Org creation ViewModel
- `workflows/src/workflows/organization-bootstrap/workflow.ts` - Organization bootstrap workflow

**Invitation System**:
- `frontend/src/pages/organizations/AcceptInvitationPage.tsx` - Invitation acceptance
- `frontend/src/viewModels/organization/InvitationAcceptanceViewModel.ts` - Invitation ViewModel
- `infrastructure/supabase/functions/validate-invitation/index.ts` - Edge Function
- `infrastructure/supabase/functions/accept-invitation/index.ts` - Edge Function

## Key Patterns and Conventions

### MobX State Management
- **Pattern**: All ViewModels extend base class, use `makeAutoObservable()`
- **Rule**: Always wrap components with `observer()` HOC
- **Rule**: Never spread observable arrays (use `.slice()` or `toJS()`)
- **Rule**: Use `runInAction()` for async updates after await

### Radix UI + Tailwind
- **Pattern**: Use Radix UI primitives for accessible, unstyled components
- **Pattern**: Style with Tailwind + CVA for variants
- **Pattern**: Forward refs for polymorphic components (`asChild` prop)

### Temporal Workflows (for complex orchestration only)
- **Pattern**: Workflows orchestrate, activities execute
- **Pattern**: Every activity emits domain event to `domain_events` table
- **Pattern**: Idempotent activities (check if operation already completed)
- **Pattern**: Saga compensation for rollback
- **Decision**: OU CRUD does NOT use Temporal - uses Supabase RPC directly (synchronous DB transaction)
- **Temporal IS appropriate for**: Organization bootstrap (DNS, email), custom role management (complex validation)

### CQRS Event Sourcing
- **Pattern**: All state changes emit domain events (immutable audit trail)
- **Pattern**: PostgreSQL triggers update CQRS projections
- **Pattern**: Frontend queries projections (read models)

### Multi-Tenant Security
- **Pattern**: JWT claims include `org_id`, `scope_path`
- **Pattern**: RLS policies enforce org isolation automatically
- **Pattern**: Never trust client-side org filtering (always RLS)

## Reference Materials

**Architecture Documentation**:
- `documentation/architecture/authentication/frontend-auth-architecture.md` - Three-mode auth system
- `documentation/architecture/authorization/rbac-architecture.md` - Role-based access control
- `documentation/architecture/data/multi-tenancy-architecture.md` - Organization isolation with RLS
- `documentation/architecture/workflows/temporal-overview.md` - Workflow orchestration
- `documentation/architecture/authentication/impersonation-architecture.md` - Impersonation (future)

**Implementation Guides**:
- `documentation/frontend/guides/EVENT-DRIVEN-GUIDE.md` - CQRS patterns in React
- `documentation/infrastructure/guides/supabase/JWT-CLAIMS-SETUP.md` - Database hooks
- `documentation/infrastructure/guides/supabase/SQL_IDEMPOTENCY_AUDIT.md` - Migration patterns

**Database Reference**:
- `documentation/infrastructure/reference/database/tables/` - Complete schema documentation
- `documentation/infrastructure/guides/supabase/docs/EVENT-DRIVEN-ARCHITECTURE.md` - Backend event sourcing

**Skill Guides**:
- `.claude/skills/temporal-workflow-guidelines/` - Temporal.io workflow patterns
- `.claude/skills/frontend-dev-guidelines/` - React + MobX + Radix UI patterns
- `.claude/skills/infrastructure-guidelines/` - Supabase SQL, RLS, migrations

## Important Constraints

### Security Constraints
1. **RLS Enforcement**: Provider admins can ONLY access data within their organization
2. **No Cross-Org Access**: Even with direct URL access, RLS blocks unauthorized queries
3. **JWT Validation**: Subdomain (future) must match JWT org_id claim
4. **Audit Trail**: All data usage agreement acceptance must be logged (HIPAA compliance)

### Business Constraints
1. **Wizard Cannot Be Skipped**: First-time login MUST complete wizard (blocking)
2. **Provider Admins Have All Permissions**: Within their org, full access (no role restrictions)
3. **Platform Owners Manage Cross-Org**: Only super_admin can see all organizations
4. **Impersonation Required for Support**: Super admins need impersonation to help providers (future)

### Technical Constraints
1. **ltree Extension**: OU hierarchy uses PostgreSQL ltree (efficient, but vendor-specific)
2. **Temporal.io Required for Complex Workflows**: Organization bootstrap, custom roles need Temporal cluster
3. **OU CRUD Does NOT Require Temporal**: Uses Supabase RPC directly (no worker dependency)
4. **Supabase Edge Functions**: Invitation validation uses Deno runtime (not Node.js)
5. **localStorage Limits**: Wizard state limited to 5MB (browser constraint)

### Performance Constraints
1. **OU Depth Limit**: Recommend max 5 levels deep (ltree performs well, but UX suffers)
2. **Permission Selector**: 200+ permissions in grid (optimize rendering with virtualization)
3. **Tree View**: Large hierarchies (500+ OUs) need lazy loading (future optimization)

## Why This Approach?

### Why Blocking Wizard vs Optional Setup?
**Chosen**: Blocking wizard that must be completed before app access
**Alternative**: Optional wizard with soft prompts (banners, nudges)

**Rationale**:
- **Data Quality**: Ensures all provider admins accept HIPAA agreements (regulatory requirement)
- **Onboarding Success**: Guided setup increases likelihood of proper OU/role configuration
- **Support Reduction**: Users who complete setup have fewer support tickets
- **Precedent**: Industry best practice (Salesforce, Workday use blocking setup wizards)

**Trade-offs**:
- **Higher Friction**: Users can't explore app before committing to setup
- **Abandonment Risk**: Some users may close browser mid-wizard (mitigated by auto-save)

### Why Separate Routes (/organizations vs /organization-units)?
**Chosen**: Separate routes for platform owners vs provider admins
**Alternative**: Overload `/organizations` with role-based conditional rendering

**Rationale**:
- **Code Clarity**: No complex role-based conditionals in components
- **Semantic Separation**: `/organizations` (platform-level root orgs) vs `/organization-units` (internal hierarchy)
- **Future-Proof**: Easier to add features to each route independently
- **Testing**: Can test platform and provider routes separately

**Trade-offs**:
- **URL Inconsistency**: Different routes for similar concepts (org management)
- **Navigation Updates**: Need to update nav items to show correct routes per role

**Note**: Updated 2025-12-08 to use `/organization-units` consistently with active plan.

### Why Optional OU/Role Creation vs Required?
**Chosen**: Optional (0+ OUs, 0+ roles)
**Alternative**: Require at least 1 OU and 1 custom role

**Rationale**:
- **Flexibility**: Small providers (single location) don't need complex hierarchies
- **Speed**: Reduces wizard completion time for simple use cases
- **No Wrong Answer**: Provider can always add OUs/roles later via settings

**Trade-offs**:
- **Incomplete Setups**: Some users may never define proper structure
- **Inconsistent Data**: Some orgs have OUs, others don't (makes reporting harder)

### Why Defer Subdomain Routing to Phase 2?
**Chosen**: Path-based routing for MVP, subdomain routing in future
**Alternative**: Implement subdomain routing immediately

**Rationale**:
- **Timeline**: Subdomain routing adds 5-7 days (wildcard DNS, TLS, nginx config)
- **Risk**: Infrastructure changes have higher failure risk than frontend changes
- **Additive**: Can add subdomain routing later without breaking existing UX
- **MVP Focus**: Onboarding flow is higher priority than subdomain isolation

**Trade-offs**:
- **User Experience**: Path-based routing feels less "white-labeled" than subdomain
- **Future Work**: Will need to migrate users to subdomains eventually

### Why Custom Roles vs Role Templates Only?
**Chosen**: Full permission selection for custom roles
**Alternative**: Use only global role templates (clinician, nurse, etc.)

**Rationale**:
- **Real-World Need**: Providers have org-specific roles (e.g., "Senior Nurse Practitioner" with custom permissions)
- **Flexibility**: Different providers have different permission requirements
- **Competitive Advantage**: Most competitors only offer fixed role templates

**Trade-offs**:
- **Complex UI**: Permission selector grid with 200+ permissions is intimidating
- **User Confusion**: Users may grant inappropriate permissions (mitigate with role templates)
- **Support Burden**: More configuration options = more support tickets

### Why Wizard-Guided Navigation vs Fixed Redirect?
**Chosen**: Redirect based on wizard state (OUs created → structure, roles → users, etc.)
**Alternative**: Always redirect to dashboard after wizard

**Rationale**:
- **Natural Flow**: Users land where they need to continue work (context-aware)
- **Discoverability**: Guides users to next logical step (progressive disclosure)
- **Momentum**: Keeps users engaged by showing immediate next action

**Trade-offs**:
- **Complexity**: More logic to determine redirect destination
- **Predictability**: Less predictable UX (users may expect fixed destination)
