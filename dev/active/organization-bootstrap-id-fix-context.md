# Context: Organization Bootstrap ID Fix

## Decision Record

**Date**: 2025-12-09
**Feature**: Organization Bootstrap ID Mismatch Fix
**Goal**: Fix the ID propagation issue preventing real-time status tracking of organization bootstrap workflows

### Key Decisions

1. **Unified ID System**: The `organizationId` generated by the Backend API must be used consistently as:
   - Frontend route parameter for status page (`/organizations/:organizationId/bootstrap-status`)
   - `stream_id` for all domain events (enables status polling)
   - Suffix in Temporal workflow ID (`org-bootstrap-{subdomain}-{timestamp}`)
   - `aggregate_id` for the organization entity

2. **2-Hop Architecture**: Frontend cannot call Temporal directly. Flow is:
   - Frontend → Backend API (Fastify on Temporal worker) → Temporal → Events → PostgreSQL

3. **Event-First Pattern**: Activities emit domain events BEFORE creating projections. The projections are updated by PostgreSQL triggers listening to the `domain_events` table.

4. **Status Polling via Edge Function**: The `workflow-status` Edge Function calls `api.get_bootstrap_status` RPC which queries `domain_events` by `stream_id`.

## Technical Context

### Architecture

```
Frontend                    Backend API                  Temporal Workflow
   |                            |                              |
   |-- POST /bootstrap -------->|                              |
   |                            |-- Generate organizationId    |
   |                            |-- Emit bootstrap.initiated   |
   |                            |   (stream_id: organizationId)|
   |                            |                              |
   |                            |-- Start workflow ----------->|
   |                            |   args: { organizationId }   |
   |                            |                              |
   |<-- Return organizationId --|                              |
   |                            |                              |-- Use organizationId
   |                            |                              |-- Emit organization.created
   |                            |                              |   (stream_id: organizationId)
   |                            |                              |
   |-- Poll /workflow-status/:id -----> Edge Function          |
   |                                       |                   |
   |                            RPC: api.get_bootstrap_status  |
   |                            Query: stream_id = organizationId
   |                                                           |
   |<-- Status JSON (stage, progress) ------------------------|
```

### Tech Stack

- **Frontend**: React + TypeScript, polling via `TemporalWorkflowClient.ts`
- **Backend API**: Fastify running on Temporal worker container
- **Workflow Engine**: Temporal.io with `@temporalio/client` and `@temporalio/worker`
- **Database**: PostgreSQL (Supabase) with CQRS projections
- **Edge Functions**: Supabase Edge Functions (Deno) for status queries
- **DNS**: Cloudflare API for subdomain provisioning

### Dependencies

- Temporal server running in Kubernetes (`temporal` namespace)
- Supabase project with Edge Functions deployed
- PostgreSQL triggers processing domain events
- `api.get_bootstrap_status` RPC function

## Diagnostic Findings

### Issue #1: Missing `organizationId` in Temporal Workflow Input

**Evidence from Temporal workflow history** (workflow `org-bootstrap-poc-test4-20251209-1765334499562`):

```
WorkflowExecutionStarted:
  Input: [{"subdomain":"poc-test4-20251209","orgData":{...},"users":[...],"frontendUrl":"..."}]
```

**Expected**:
```
  Input: [{"organizationId":"4d02fc82-c02c-49f7-81f9-21934ad7fca6","subdomain":"poc-test4-20251209",...}]
```

The `organizationId` is NOT in the workflow input despite API code appearing to pass it.

### Issue #2: ID Mismatch Between API and Workflow

| Source | ID |
|--------|-----|
| API generated | `4d02fc82-c02c-49f7-81f9-21934ad7fca6` |
| Workflow used | `3efe938a-213a-4ca4-b1d9-761a9f0060f4` |

The workflow generates its own UUID because it doesn't receive the API's ID.

### Issue #3: Database Migration Not Applied ✅ FIXED

**File**: `infrastructure/supabase/sql/04-triggers/bootstrap-event-listener.sql`

The SQL file contains an updated `get_bootstrap_status` function with columns:
- `domain` (text)
- `dns_configured` (boolean)
- `invitations_sent` (integer)

**Resolution**: Applied via Supabase MCP `apply_migration` tool on 2025-12-10

### Issue #4: No `organization.created` Events

Database query for last 24 hours:
```sql
SELECT event_type, count(*) FROM domain_events
WHERE created_at > now() - interval '24 hours'
GROUP BY event_type;
```

Results:
- `organization.bootstrap.initiated`: 4
- `contact.created`: 4
- `address.created`: 4
- `phone.created`: 4
- `organization.created`: 0 (MISSING!)

### Issue #5: Event Stream ID Fragmentation

Events are emitted with entity-specific `stream_id`s instead of `organizationId`:

| Event Type | stream_id |
|------------|-----------|
| `organization.bootstrap.initiated` | `4d02fc82...` (API's ID) |
| `contact.created` | Contact's own UUID |
| `address.created` | Address's own UUID |
| `organization.created` | Not emitted |

Status query by `organizationId` only finds `bootstrap.initiated`.

## File Structure

### Critical Files to Modify

- `workflows/src/api/routes/workflows.ts:85-110` - Backend API workflow start
  - Generates organizationId, passes to Temporal client
  - ✅ FIXED: Removed UUID collision validation query (was lines 95-131, now removed)
  - Query was failing due to RLS issues on `organizations_projection`

- `workflows/src/activities/organization-bootstrap/create-organization.ts:61-67` - Idempotency check
  - ✅ FIXED: Now returns `params.organizationId` instead of `existing.id`
  - Ensures unified ID system works on activity retries

- `infrastructure/supabase/sql/04-triggers/bootstrap-event-listener.sql` - Status function
  - Contains updated `get_bootstrap_status` with new columns
  - ✅ FIXED: Applied to production database via Supabase MCP on 2025-12-10

- `workflows/src/shared/utils/emit-event.ts` - Event emission utility
  - Uses `aggregate_id` as `stream_id`
  - May need org context for child entities

### Related Files (Read-Only Reference)

- `workflows/src/workflows/organization-bootstrap/workflow.ts` - Workflow definition
- `workflows/src/shared/types/index.ts` - TypeScript type definitions
- `infrastructure/supabase/supabase/functions/workflow-status/index.ts` - Edge Function
- `frontend/src/services/workflow/TemporalWorkflowClient.ts` - Frontend client
- `frontend/src/pages/organizations/OrganizationBootstrapStatusPage.tsx` - Status UI

## Key Patterns and Conventions

### Unified ID System Pattern

```typescript
// Backend API generates the ID
const organizationId = uuidv4();

// Emit initial event with organizationId as stream_id
await emitEvent({
  event_type: 'organization.bootstrap.initiated',
  aggregate_type: 'organization',
  aggregate_id: organizationId,  // This becomes stream_id
  event_data: { ... }
});

// Pass to Temporal workflow
await client.workflow.start('organizationBootstrapWorkflow', {
  args: [{ organizationId, subdomain, orgData, users }]
});

// Return to frontend for status polling
return { organizationId };
```

### Event Emission Pattern

```typescript
// All org-related events should use organizationId as stream_id
await emitEvent({
  event_type: 'organization.created',
  aggregate_type: 'organization',
  aggregate_id: orgId,  // organizationId from params
  event_data: { ... }
});
```

## Important Constraints

1. **Temporal Determinism**: Workflows must be deterministic. No random UUIDs inside workflow code - generate in activities or pass from API.

2. **Event Immutability**: Once emitted, events cannot be modified. Fix must ensure correct IDs from the start.

3. **Backwards Compatibility**: Existing workflows in flight may have wrong IDs. Focus on fixing new workflows.

4. **RLS Policies**: Events may have RLS policies. Ensure service role is used for event emission.

5. **UUID Collision Check** (Added 2025-12-10): Removed the UUID collision validation query from API. The check was failing due to RLS issues and was unnecessary - UUID collision probability is 1 in 2^122, and Temporal workflow ID uniqueness provides collision protection.

6. **Development Guideline** (Added 2025-12-10): Run `npm run build` in `workflows/` after each major code change to catch TypeScript errors early.

## Why This Approach?

**Why Unified ID System?**
- Single source of truth for organization identity
- Frontend can poll status without knowing Temporal workflow ID
- Events queryable by business entity, not implementation detail
- Enables CQRS projections to aggregate all org-related events

**Why Not Generate ID in Workflow?**
- Workflow doesn't run until after API returns to frontend
- Frontend needs ID immediately for status page routing
- Temporal workflow IDs are implementation details, not business identifiers

**Why Event-First?**
- Audit trail of all state changes
- Projections derived from events (CQRS)
- Enables event replay for debugging
- Decouples workflow execution from data persistence
