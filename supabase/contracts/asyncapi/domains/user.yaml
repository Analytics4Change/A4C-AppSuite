components:
  messages:
    UserSyncedFromZitadel:
      name: user.synced_from_zitadel
      title: User Synced from Zitadel
      summary: User information synchronized from Zitadel identity provider
      contentType: application/json
      payload:
        $ref: '#/components/schemas/UserSyncedEvent'

    UserOrganizationSwitched:
      name: user.organization_switched
      title: User Organization Switched
      summary: User switched their active organization context
      contentType: application/json
      payload:
        $ref: '#/components/schemas/UserOrgSwitchedEvent'

  schemas:
    UserSyncedEvent:
      type: object
      required:
        - stream_id
        - stream_type
        - event_type
        - event_data
        - event_metadata
      properties:
        stream_id:
          type: string
          format: uuid
        stream_type:
          type: string
          const: user
        event_type:
          type: string
          const: user.synced_from_zitadel
        event_data:
          type: object
          required:
            - external_id
            - email
            - roles
          properties:
            external_id:
              type: string
              description: Zitadel User ID
            email:
              type: string
              format: email
            name:
              type: string
            roles:
              type: array
              items:
                type: string
                enum:
                  - super_admin
                  - administrator
                  - clinician
                  - specialist
                  - parent
                  - youth
            accessible_organizations:
              type: array
              items:
                type: string
                format: uuid
        event_metadata:
          allOf:
            - $ref: '../components/schemas.yaml#/components/schemas/EventMetadata'
            - properties:
                reason:
                  examples:
                    - "Initial user sync after Zitadel registration"
                    - "Role update sync after admin promotion"
                    - "Periodic sync to ensure consistency"

    UserOrgSwitchedEvent:
      type: object
      required:
        - stream_id
        - stream_type
        - event_type
        - event_data
        - event_metadata
      properties:
        stream_id:
          type: string
          format: uuid
        stream_type:
          type: string
          const: user
        event_type:
          type: string
          const: user.organization_switched
        event_data:
          type: object
          required:
            - user_id
            - from_organization_id
            - to_organization_id
          properties:
            user_id:
              type: string
              format: uuid
            from_organization_id:
              type: string
              format: uuid
              nullable: true
            to_organization_id:
              type: string
              format: uuid
        event_metadata:
          allOf:
            - $ref: '../components/schemas.yaml#/components/schemas/EventMetadata'
            - properties:
                reason:
                  examples:
                    - "User selected different organization from dropdown"
                    - "Automatic switch after single org access granted"
                    - "Session initialization with default organization"